# ğŸŒ Universal Order Number System Documentation

## ğŸ“‹ Overview

The Al Marya Rostery application now uses a **unified, backend-driven order number generation system** that ensures consistent order tracking across all platforms:

- âœ… **Customer App** (Flutter)
- âœ… **Staff App** (Flutter)
- âœ… **Driver App** (Flutter)
- âœ… **Admin Panel** (Web)
- âœ… **Backend API** (Node.js)

## ğŸ¯ Order Number Format

```
ALM-YYYYMMDD-XXXXXX
```

### Components:

| Part | Description | Example |
|------|-------------|---------|
| `ALM` | Brand prefix (Al Marya) | `ALM` |
| `YYYYMMDD` | Date (Year-Month-Day) | `20251106` |
| `XXXXXX` | Sequential number (6 digits, resets daily) | `000123` |

### Example Order Numbers:

- `ALM-20251106-000001` â†’ First order on November 6, 2025
- `ALM-20251106-000002` â†’ Second order on November 6, 2025
- `ALM-20251107-000001` â†’ First order on November 7, 2025 (reset)

## ğŸ—ï¸ Architecture

### Backend Implementation

#### 1. Order Number Generator (`/backend/utils/orderNumberGenerator.js`)

**Key Features:**
- âœ… Atomic database operations (prevents duplicates)
- âœ… Daily sequence counter (resets automatically)
- âœ… Fallback mechanism (if DB fails)
- âœ… Thread-safe for concurrent orders

**Main Function:**
```javascript
const { generateOrderNumber } = require('./utils/orderNumberGenerator');

// Usage in order creation
const orderNumber = await generateOrderNumber();
// Returns: "ALM-20251106-000123"
```

**Database Schema:**
```javascript
Counter Collection:
{
  _id: "order-YYYYMMDD",     // e.g., "order-20251106"
  sequence: 123,              // Current sequence
  date: Date,                 // Counter creation date
  createdAt: Date,
  updatedAt: Date
}
```

#### 2. Order Controller Integration (`/backend/controllers/orderController.js`)

**Before (Old System):**
```javascript
// âŒ Old inconsistent format
const orderNumber = `ORD-${Date.now()}-${Math.random().toString(36).substr(2, 9).toUpperCase()}`;
```

**After (New System):**
```javascript
// âœ… New unified format
const { generateOrderNumber } = require('../utils/orderNumberGenerator');
const orderNumber = await generateOrderNumber();
```

#### 3. Order Model (`/backend/models/Order.js`)

**Schema Field:**
```javascript
orderNumber: {
  type: String,
  required: true,
  unique: true,
  index: true
}
```

**Note:** Order number is now generated by the controller before saving (not in pre-save hook).

## ğŸ”„ Migration from Old System

### Old Order Number Formats Found:

1. `QA` prefix: `QA${timestamp}${random}` (Order model pre-save)
2. `ORD-` prefix: `ORD-${Date.now()}-${random}` (Order controller)
3. Test prefixes: `ORD-TEST-`, `ORD-CANCEL-` (Test scripts)

### Migration Strategy:

**Existing orders keep their old numbers** - no data migration needed.
**New orders use the new format** - ALM-YYYYMMDD-XXXXXX.

This ensures:
- âœ… No breaking changes to existing orders
- âœ… All future orders use consistent format
- âœ… Search and filtering works for both formats

## ğŸ“± Frontend Integration

### Customer App Display

**Order Confirmation Screen:**
```dart
// lib/features/orders/models/order_model.dart
class Order {
  final String orderNumber; // From API
  // ... other fields
}

// Display in UI
Text('Order #${order.orderNumber}')
// Shows: "Order #ALM-20251106-000123"
```

**Order History:**
```dart
// lib/features/orders/widgets/order_card.dart
OrderCard(
  orderNumber: order.orderNumber, // No formatting needed
  // ... other props
)
```

### Staff App Display

**Order List:**
```dart
// al_marya_staff_app/lib/features/orders/widgets/order_card.dart
Text('Order #${order.orderNumber}')
```

**Order Details:**
```dart
// al_marya_staff_app/lib/features/orders/screens/order_details_screen.dart
OrderDetailRow(
  label: 'Order Number',
  value: order.orderNumber,
)
```

### Driver App Display

**Available Deliveries:**
```dart
// al_marya_driver_app/lib/features/deliveries/widgets/order_card.dart
Text('Order #${order.orderNumber}')
// Shows on delivery card
```

**My Deliveries:**
```dart
// al_marya_driver_app/lib/features/deliveries/screens/deliveries_list_screen.dart
ListTile(
  title: Text('Order #${order.orderNumber}'),
  // ... other fields
)
```

## ğŸ§ª Testing

### Run Order Number Generator Tests:

```bash
cd backend
node test-order-number-generator.js
```

**Test Coverage:**
1. âœ… Single order number generation
2. âœ… Format validation (ALM-YYYYMMDD-XXXXXX)
3. âœ… Sequential numbering (5 consecutive orders)
4. âœ… Current sequence tracking
5. âœ… Concurrent generation (10 simultaneous orders)
6. âœ… Duplicate prevention (atomic operations)
7. âœ… Database counter verification

### Expected Output:

```
âœ… Order number format is correct (ALM-YYYYMMDD-XXXXXX)
âœ… Order numbers are sequential
âœ… Sequence is tracking correctly (16 orders today)
âœ… No duplicate order numbers (atomic operations working!)
âœ… Counter document found: order-20251106
```

## ğŸ”§ Utilities & Tools

### Available Functions:

```javascript
const { 
  generateOrderNumber, 
  getCurrentSequence, 
  resetSequence, 
  Counter 
} = require('./utils/orderNumberGenerator');

// Generate order number
const orderNum = await generateOrderNumber();
// Returns: "ALM-20251106-000001"

// Get current sequence for today
const count = await getCurrentSequence();
// Returns: 16

// Get sequence for specific date
const yesterdayCount = await getCurrentSequence(new Date('2025-11-05'));
// Returns: 0 (or count from that day)

// Reset sequence (use with caution!)
await resetSequence();
// Deletes counter for today
```

## ğŸš€ API Response Example

### Create Order Endpoint: `POST /api/orders`

**Request:**
```json
{
  "items": [...],
  "totalAmount": 205.00,
  "shippingAddress": {...},
  "paymentMethod": "card"
}
```

**Response:**
```json
{
  "success": true,
  "message": "Order created successfully",
  "order": {
    "_id": "673bbf9dd7e6d7c8e1a1234a",
    "orderNumber": "ALM-20251106-000123",
    "items": [...],
    "totalAmount": 205.00,
    "status": "pending",
    "createdAt": "2025-11-06T14:11:17.814Z",
    "updatedAt": "2025-11-06T14:11:17.814Z"
  }
}
```

### Get Orders Endpoint: `GET /api/orders`

**Response:**
```json
{
  "success": true,
  "orders": [
    {
      "_id": "673bbf9dd7e6d7c8e1a1234a",
      "orderNumber": "ALM-20251106-000123",
      "status": "pending",
      "totalAmount": 205.00
    },
    {
      "_id": "673bbf9dd7e6d7c8e1a1234b",
      "orderNumber": "ALM-20251106-000124",
      "status": "processing",
      "totalAmount": 150.00
    }
  ]
}
```

## ğŸ“Š Database Collections

### Orders Collection:
```javascript
{
  _id: ObjectId,
  orderNumber: "ALM-20251106-000123",  // â† Unique, indexed
  user: ObjectId,
  items: [...],
  totalAmount: 205.00,
  status: "pending",
  createdAt: Date,
  updatedAt: Date
}
```

### Counters Collection (New):
```javascript
{
  _id: "order-20251106",  // â† Daily counter
  sequence: 123,
  date: Date,
  createdAt: Date,
  updatedAt: Date
}
```

## ğŸ” Search & Filtering

### Backend Search Example:

```javascript
// Search by order number
const orders = await Order.find({
  orderNumber: { $regex: 'ALM-20251106', $options: 'i' }
});

// Search by exact order number
const order = await Order.findOne({ orderNumber: 'ALM-20251106-000123' });

// Get orders for specific date
const dateOrders = await Order.find({
  orderNumber: { $regex: '^ALM-20251106-', $options: 'i' }
});
```

### Frontend Search (Flutter):

```dart
// Filter orders by order number
final filteredOrders = orders.where((order) => 
  order.orderNumber.toLowerCase().contains(searchQuery.toLowerCase())
).toList();
```

## âš¡ Performance Considerations

### Atomic Operations:
- Uses `findOneAndUpdate` with `upsert` option
- Prevents race conditions during concurrent orders
- Guarantees unique sequential numbers

### Indexing:
- `orderNumber` field is indexed for fast lookups
- Unique constraint prevents duplicates at DB level

### Daily Reset:
- Counters automatically start at 1 each day
- Old counter documents remain for audit trail
- No manual reset needed

## ğŸ” Security & Best Practices

### âœ… DO:
- Use `generateOrderNumber()` in order creation endpoint only
- Let backend generate all order numbers
- Display order numbers as-is in frontend
- Keep counter collection for audit purposes

### âŒ DON'T:
- Generate order numbers on frontend
- Manually edit order numbers in database
- Delete counter documents (affects sequence)
- Use order numbers for security/authentication

## ğŸ› Troubleshooting

### Issue: Duplicate Order Numbers

**Cause:** Database connection issue or transaction failure

**Solution:**
```javascript
// Check counter document
const Counter = require('./utils/orderNumberGenerator').Counter;
const counter = await Counter.findById('order-20251106');
console.log('Current sequence:', counter.sequence);
```

### Issue: Sequence Skipped Numbers

**Cause:** Failed order creation after number generation

**Solution:** This is normal behavior. Numbers may skip if order creation fails after number is generated.

### Issue: Wrong Date in Order Number

**Cause:** Server timezone mismatch

**Solution:** Ensure backend server timezone is set correctly:
```javascript
// In server configuration
process.env.TZ = 'Asia/Dubai'; // Gulf Standard Time
```

## ğŸ“ Support

For issues or questions about the order number system:

1. Check this documentation
2. Run test script: `node test-order-number-generator.js`
3. Review logs: Backend logs include "âœ… Generated order number:" messages
4. Check counter collection in MongoDB

## ğŸ‰ Summary

âœ… **Unified System:** One format across all apps
âœ… **Human-Readable:** Easy to read and communicate
âœ… **Sequential:** Numbers increment daily
âœ… **Reliable:** Atomic operations prevent duplicates
âœ… **Searchable:** Indexed for fast lookups
âœ… **Traceable:** Includes date in format
âœ… **Scalable:** Handles concurrent orders
âœ… **Professional:** Branded with ALM prefix

**Format:** `ALM-YYYYMMDD-XXXXXX`
**Example:** `ALM-20251106-000123`
**Status:** âœ… Implemented and Tested
