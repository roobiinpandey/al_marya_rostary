<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'unsafe-hashes' https://accounts.google.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; script-src-attr 'self' 'unsafe-inline' 'unsafe-hashes'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src-attr 'unsafe-inline'; font-src 'self' https://cdnjs.cloudflare.com data:; connect-src 'self' http://localhost:5001 http://localhost:3001 https://*.onrender.com https://*.render.com https://cdn.jsdelivr.net; img-src 'self' data: blob: http://localhost:5001 http://localhost:3001 https://*.onrender.com https://*.render.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="description" content="Al Marya Rostery Business Management Portal - Secure coffee business administration">
    <meta name="keywords" content="coffee, business, admin, management, qahwat, emirates">
    <meta name="author" content="Al Marya Rostery">
    <meta name="robots" content="noindex, nofollow">
    <title>Al Marya Rostery - Business Portal</title>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Google Identity Services script for Google Sign-In 7.x -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-brown: #8B4513;
            --secondary-brown: #D2691E;
            --light-brown: #f8f4f0;
            --dark-text: #333;
            --medium-text: #666;
            --error-color: #dc3545;
            --success-color: #28a745;
            --primary-color: #8B4513;
            --secondary-color: #D2691E;
            --accent-color: #CD853F;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #f8f9fa;
            --bg-white: #ffffff;
            --border-light: #e9ecef;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            margin: 0;
            padding: 0;
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Full screen layout for admin */
        body.admin-mode {
            background: var(--bg-light);
            display: block;
        }

        body.login-mode {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            max-width: 600px;
            width: 90%;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-size: 4rem;
            color: var(--primary-brown);
            margin-bottom: 20px;
            animation: bounce 1s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        h1 {
            color: var(--dark-text);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: var(--medium-text);
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .info {
            margin-top: 30px;
            padding: 20px;
            background: var(--light-brown);
            border-radius: 10px;
            border-left: 4px solid var(--primary-brown);
        }

        .info h3 {
            color: var(--primary-brown);
            margin-bottom: 10px;
        }

        .info p {
            color: var(--medium-text);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .login-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid var(--primary-brown);
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-text);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-brown);
            box-shadow: 0 0 0 2px rgba(139, 69, 19, 0.2);
        }

        .portal-btn {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, var(--primary-brown), var(--secondary-brown));
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.2s ease;
            min-width: 200px;
            text-align: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .portal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }

        .portal-btn:active {
            transform: translateY(0);
        }

        .portal-btn.loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .alert {
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        .alert-error {
            background-color: #f8d7da;
            color: var(--error-color);
            border: 1px solid #f5c6cb;
        }

        .alert-success {
            background-color: #d4edda;
            color: var(--success-color);
            border: 1px solid #c3e6cb;
        }

        .forgot-password {
            text-align: center;
            margin-top: 15px;
        }

        .forgot-password a {
            color: var(--primary-brown);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .login-btn:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }

        .login-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--danger);
        }

        .login-loading {
            display: none;
            text-align: center;
            margin-top: 1rem;
        }

        .login-loading i {
            font-size: 1.5rem;
            animation: spin 1s linear infinite;
        }

        .login-info {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            font-size: 0.9rem;
        }

        .login-info strong {
            color: var(--primary-color);
        }

        /* Layout */
        .admin-layout {
            display: none; /* Hidden by default, shown after login */
            min-height: 100vh;
            width: 100%;
            background: var(--bg-light);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-color), var(--secondary-color));
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            display: block;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .menu-item:hover,
        .menu-item.active {
            background: rgba(255,255,255,0.1);
            padding-left: 2rem;
        }

        .menu-item i {
            width: 20px;
            margin-right: 0.75rem;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            background-color: var(--bg-light);
        }

        /* Header */
        .content-header {
            background: var(--bg-white);
            padding: 1.5rem 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-header h2 {
            color: var(--text-dark);
            font-size: 1.8rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .stat-card .icon.primary { background: var(--primary-color); }
        .stat-card .icon.success { background: var(--success); }
        .stat-card .icon.warning { background: var(--warning); }
        .stat-card .icon.info { background: var(--info); }

        .stat-card h3 {
            font-size: 2rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-card {
            background: var(--bg-white);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .section-content {
            padding: 2rem;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-white);
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table th {
            background-color: var(--bg-light);
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }

        /* Alert styles */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        /* Firebase sync styles */
        #firebaseSyncDashboard {
            border: 2px solid #007bff;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        #firebaseSyncDashboard .section-header h3 {
            color: #007bff;
        }

        .sync-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .sync-status-synced { background-color: #28a745; }
        .sync-status-pending { background-color: #ffc107; }
        .sync-status-error { background-color: #dc3545; }
        .sync-status-manual { background-color: #6c757d; }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: var(--bg-white);
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .modal-close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        /* File Upload Area */
        .file-upload-area {
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-light);
        }

        .file-upload-area:hover {
            background: var(--border-light);
            border-color: var(--secondary-color);
        }

        .file-upload-content i {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .file-upload-content p {
            margin: 0.5rem 0;
            color: var(--text-dark);
            font-weight: 500;
        }

        .file-upload-content small {
            color: var(--text-light);
        }

        /* Notification Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .content-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }

        /* Global Loading Overlay */
        .global-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }

        .global-loading .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success/Error Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.success { background: var(--success-color); }
        .toast.error { background: var(--error-color); }
        .toast.show { transform: translateX(0); }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--text-dark);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-confirm {
            background: var(--danger);
            color: white;
        }

        .btn-cancel {
            background: var(--border-light);
            color: var(--text-dark);
        }

        /* Enhanced Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 2.5rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 50%;
            color: white;
        }

        .stat-info h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .stat-info p {
            font-size: 0.9rem;
            color: var(--text-light);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Enhanced Button Styles */
        .btn {
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Data Table Enhancements */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Global Loading Overlay -->
    <div class="global-loading" id="globalLoading">
        <div>
            <div class="spinner"></div>
            <div id="loadingText">Loading...</div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer"></div>



    <!-- Login Page -->
    <div class="login-container" id="loginContainer">
        <div class="container" role="main">
            <div class="logo" aria-hidden="true">â˜•</div>
            <h1>Al Marya Rostery</h1>
            <p class="subtitle">Business Management Portal</p>

            <div class="info">
                <h3>Admin Panel</h3>
                <p>Welcome to Your Business Portal</p>
                <p>Manage your coffee business operations from this central hub. Access the admin panel to handle inventory, orders, analytics, and customer management.</p>
            </div>

            <!-- Login Form -->
            <div class="login-form">
                <h4 style="color: var(--primary-brown); margin-bottom: 15px; text-align: center;">Admin Login</h4>
                <form id="adminLoginForm" novalidate>
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="Enter username" required aria-describedby="username-error">
                        <div id="username-error" class="alert alert-error" role="alert" aria-live="polite"></div>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Enter password" required aria-describedby="password-error">
                        <div id="password-error" class="alert alert-error" role="alert" aria-live="polite"></div>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="portal-btn" style="width: 100%; margin: 0;" id="loginBtn">Login to Admin Panel</button>
                    </div>
                    <div id="loginError" class="alert alert-error" role="alert" aria-live="assertive" style="display: none;">
                        Invalid username or password
                    </div>
                    <div id="loginSuccess" class="alert alert-success" role="alert" aria-live="assertive" style="display: none;">
                        Login successful! Redirecting...
                    </div>
                </form>
                <div class="forgot-password">
                    <a href="#" id="forgot-password-link">Forgot password?</a>
                </div>
            </div>
            
            <div class="login-loading" id="loginLoading" style="display: none;">
                <i class="fas fa-spinner"></i>
                <p>Authenticating...</p>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Hidden initially) -->
    <div class="admin-layout" id="adminLayout">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-coffee"></i> Al Marya Rostery</h1>
                <p>Administrative Panel</p>
            </div>
            <div class="sidebar-menu">
                <button class="menu-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="menu-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar"></i> Analytics
                </button>
                <button class="menu-item" onclick="showSection('reports')">
                    <i class="fas fa-file-alt"></i> Reports
                </button>
                <button class="menu-item" onclick="showSection('products')">
                    <i class="fas fa-box"></i> Products
                </button>
                <button class="menu-item" onclick="showSection('categories')">
                    <i class="fas fa-tags"></i> Categories
                </button>
                <button class="menu-item" onclick="showSection('orders')">
                    <i class="fas fa-shopping-cart"></i> Orders
                </button>
                <button class="menu-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Users
                </button>
                <button class="menu-item" onclick="showSection('sliders')">
                    <i class="fas fa-images"></i> Hero Banners
                </button>
                <button class="menu-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </button>
                <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 1rem 0;">
                <button class="menu-item" onclick="logout()" style="color: #ff6b6b;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <div class="content-header">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                    <div class="header-actions">
                        <button class="btn btn-info" onclick="refreshDashboard()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid" id="dashboardStats">
                    <!-- Stats will be loaded here -->
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Revenue Overview</h3>
                    </div>
                    <div class="section-content">
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Recent Orders</h3>
                    </div>
                    <div class="section-content">
                        <div id="recentOrdersTable">
                            <!-- Recent orders will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
                    <div class="header-actions">
                        <select class="form-control" id="analyticsDateRange" style="width: auto;">
                            <option value="7">Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 3 months</option>
                            <option value="365">Last year</option>
                        </select>
                        <button class="btn btn-info" onclick="loadAnalytics()">
                            <i class="fas fa-sync"></i> Update
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon info">
                            <i class="fas fa-eye"></i>
                        </div>
                        <h3 id="totalViews">-</h3>
                        <p>Total Page Views</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon success">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3 id="uniqueVisitors">-</h3>
                        <p>Unique Visitors</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon warning">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <h3 id="conversionRate">-</h3>
                        <p>Conversion Rate</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon primary">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3 id="avgSessionTime">-</h3>
                        <p>Avg. Session Time</p>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>User Engagement</h3>
                    </div>
                    <div class="section-content">
                        <div class="chart-container">
                            <canvas id="engagementChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Popular Products</h3>
                    </div>
                    <div class="section-content">
                        <div id="popularProductsTable">
                            <!-- Popular products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-file-alt"></i> Reports & Analytics</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="generateReport()">
                            <i class="fas fa-plus"></i> Generate Report
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Report Generator</h3>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label>Report Type</label>
                                    <select class="form-control" id="reportType">
                                        <option value="sales">Sales Report</option>
                                        <option value="users">User Activity Report</option>
                                        <option value="products">Product Performance Report</option>
                                        <option value="revenue">Revenue Report</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Date Range</label>
                                    <select class="form-control" id="reportDateRange">
                                        <option value="today">Today</option>
                                        <option value="yesterday">Yesterday</option>
                                        <option value="7">Last 7 days</option>
                                        <option value="30">Last 30 days</option>
                                        <option value="90">Last 3 months</option>
                                        <option value="custom">Custom Range</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Output Format</label>
                                    <select class="form-control" id="reportFormat">
                                        <option value="pdf">PDF</option>
                                        <option value="csv">CSV</option>
                                        <option value="excel">Excel</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" onclick="downloadReport()" style="width: 100%;">
                                        <i class="fas fa-download"></i> Download Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Recent Reports</h3>
                    </div>
                    <div class="section-content">
                        <div id="reportsTable">
                            <!-- Reports table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-box"></i> Product Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Coffee Products</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" class="form-control" placeholder="Search products..." id="productSearch" style="width: 250px;">
                            <select class="form-control" id="productCategoryFilter" style="width: 150px;">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="productsTable">
                            <!-- Products table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categories" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-tags"></i> Category Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="showAddCategoryModal()">
                            <i class="fas fa-plus"></i> Add Category
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Product Categories</h3>
                    </div>
                    <div class="section-content">
                        <div id="categoriesTable">
                            <!-- Categories table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders Section -->
            <div id="orders" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-shopping-cart"></i> Order Management</h2>
                    <div class="header-actions">
                        <select class="form-control" id="orderStatusFilter" style="width: auto;">
                            <option value="">All Orders</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <button class="btn btn-info" onclick="loadOrders()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3 id="pendingOrders">-</h3>
                        <p>Pending Orders</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon info">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <h3 id="preparingOrders">-</h3>
                        <p>Preparing Orders</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 id="completedOrders">-</h3>
                        <p>Completed Today</p>
                    </div>
                    <div class="stat-card">
                        <div class="icon primary">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <h3 id="todayRevenue">-</h3>
                        <p>Today's Revenue</p>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Order List</h3>
                    </div>
                    <div class="section-content">
                        <div id="ordersTable">
                            <!-- Orders table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-users"></i> User Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="showAddUserModal()">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                        <button class="btn btn-info" onclick="showFirebaseSyncDashboard()">
                            <i class="fas fa-sync"></i> Firebase Sync
                        </button>
                    </div>
                </div>

                <!-- Firebase Sync Dashboard -->
                <div class="section-card" id="firebaseSyncDashboard" style="display: none;">
                    <div class="section-header">
                        <h3><i class="fas fa-cloud"></i> Firebase Sync Dashboard</h3>
                        <button class="btn btn-secondary btn-sm" onclick="loadFirebaseSyncStatus()">
                            <i class="fas fa-refresh"></i> Refresh Status
                        </button>
                    </div>
                    <div class="section-content">
                        <!-- Sync Status Cards -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="syncTotalUsers">0</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="syncSyncedUsers">0</div>
                                <div class="stat-label">Synced to Firebase</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="syncPendingUsers">0</div>
                                <div class="stat-label">Pending Sync</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="syncErrorUsers">0</div>
                                <div class="stat-label">Sync Errors</div>
                            </div>
                        </div>

                        <!-- Manual Sync Actions -->
                        <h4><i class="fas fa-hand-paper"></i> Manual Sync Actions</h4>
                        <div style="margin: 1rem 0 2rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-info" onclick="validateUsersForFirebase()">
                                <i class="fas fa-check-circle"></i> Validate User Emails
                            </button>
                            <button class="btn btn-primary" onclick="bulkSyncToFirebase()">
                                <i class="fas fa-cloud-upload-alt"></i> Sync All to Firebase (Advanced)
                            </button>
                            <button class="btn btn-secondary" onclick="bulkSyncFromFirebase()">
                                <i class="fas fa-cloud-download-alt"></i> Sync All from Firebase (Advanced)
                            </button>
                            <button class="btn btn-success" onclick="quickSyncToFirebase()">
                                <i class="fas fa-bolt"></i> Quick Sync (Pending Only)
                            </button>
                            <button class="btn btn-warning" onclick="showPendingSyncUsers()">
                                <i class="fas fa-exclamation-triangle"></i> Show Pending
                            </button>
                            <button class="btn btn-info" onclick="showFirebaseUsers()">
                                <i class="fas fa-list"></i> View Firebase Users
                            </button>
                        </div>

                        <!-- Auto Sync Controls -->
                        <div class="section-card" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border: 2px solid #2196f3;">
                            <h4><i class="fas fa-robot"></i> Automatic Real-Time Sync</h4>
                            <p style="color: #666; margin-bottom: 1.5rem;">
                                <i class="fas fa-info-circle"></i> When enabled, new Firebase users will automatically appear in the admin panel within 1 minute.
                            </p>
                            
                            <!-- Auto Sync Status -->
                            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                                <div class="stat-card">
                                    <div class="stat-number" id="autoSyncStatus">Loading...</div>
                                    <div class="stat-label">Auto Sync Status</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="autoSyncLastRun">Never</div>
                                    <div class="stat-label">Last Auto Sync</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="autoSyncSuccessRate">0%</div>
                                    <div class="stat-label">Success Rate</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-number" id="autoSyncNextRun">--</div>
                                    <div class="stat-label">Next Sync In</div>
                                </div>
                            </div>

                            <!-- Auto Sync Controls -->
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <button class="btn btn-success" id="startAutoSyncBtn" onclick="startAutoSync()">
                                    <i class="fas fa-play"></i> Start Auto Sync
                                </button>
                                <button class="btn btn-danger" id="stopAutoSyncBtn" onclick="stopAutoSync()" style="display: none;">
                                    <i class="fas fa-stop"></i> Stop Auto Sync
                                </button>
                                <button class="btn btn-primary" onclick="forceAutoSync()">
                                    <i class="fas fa-sync"></i> Force Sync Now
                                </button>
                                <button class="btn btn-secondary" onclick="loadAutoSyncStatus()">
                                    <i class="fas fa-refresh"></i> Refresh Status
                                </button>
                            </div>

                            <!-- Sync Interval Control -->
                            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                                <label for="syncIntervalSelect" style="font-weight: 500; min-width: 100px;">Sync Interval:</label>
                                <select class="form-control" id="syncIntervalSelect" style="width: 200px;" onchange="updateSyncInterval()">
                                    <option value="30000">30 seconds</option>
                                    <option value="60000" selected>1 minute</option>
                                    <option value="120000">2 minutes</option>
                                    <option value="300000">5 minutes</option>
                                    <option value="600000">10 minutes</option>
                                    <option value="1800000">30 minutes</option>
                                </select>
                                <small style="color: #666; flex: 1;">How often to check for new Firebase users</small>
                            </div>
                        </div>

                        <!-- Sync Results -->
                        <div id="syncResults" style="display: none;">
                            <h4>Sync Results</h4>
                            <div id="syncResultsContent"></div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Registered Users</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" class="form-control" placeholder="Search users..." id="userSearch" style="width: 250px;">
                            <select class="form-control" id="userRoleFilter" style="width: 150px;">
                                <option value="">All Roles</option>
                                <option value="customer">Customer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="usersTable">
                            <!-- Users table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-cog"></i> System Settings</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>General Settings</h3>
                    </div>
                    <div class="section-content">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                            <div>
                                <div class="form-group">
                                    <label>App Name</label>
                                    <input type="text" class="form-control" id="appName" value="Al Marya Rostery">
                                </div>
                                <div class="form-group">
                                    <label>Contact Email</label>
                                    <input type="email" class="form-control" id="contactEmail" value="info@qahwatalemarat.com">
                                </div>
                                <div class="form-group">
                                    <label>Contact Phone</label>
                                    <input type="tel" class="form-control" id="contactPhone" value="+971501234567">
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Currency</label>
                                    <select class="form-control" id="currency">
                                        <option value="AED">AED (Ø¯.Ø¥)</option>
                                        <option value="USD">USD ($)</option>
                                        <option value="EUR">EUR (â‚¬)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Default Language</label>
                                    <select class="form-control" id="defaultLanguage">
                                        <option value="ar">Arabic</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Timezone</label>
                                    <select class="form-control" id="timezone">
                                        <option value="Asia/Dubai">Asia/Dubai (GST)</option>
                                        <option value="UTC">UTC</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sliders Section -->
            <div id="sliders" class="content-section">
                <div class="content-header">
                    <h2><i class="fas fa-images"></i> Hero Banner Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="showAddSliderModal()">
                            <i class="fas fa-plus"></i> Create New Banner
                        </button>
                        <button class="btn btn-info" onclick="loadSliders()">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Slider Creation Modal -->
                <div id="sliderModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-images"></i> Create Hero Banner</h3>
                            <span class="modal-close" onclick="hideAddSliderModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <form id="sliderForm" enctype="multipart/form-data">
                                <!-- Image Upload -->
                                <div class="form-group">
                                    <label for="sliderImage">Banner Image *</label>
                                    <div class="file-upload-area" onclick="document.getElementById('sliderImage').click()">
                                        <input type="file" id="sliderImage" name="image" accept="image/*" required style="display: none;">
                                        <div class="file-upload-content">
                                            <i class="fas fa-camera fa-2x"></i>
                                            <p>Click to select banner image</p>
                                            <small>Recommended: 1920x600px, JPG/PNG, max 10MB</small>
                                        </div>
                                    </div>
                                    <div id="imagePreview" style="display: none; margin-top: 10px;">
                                        <img id="previewImg" src="" alt="Preview" style="max-width: 200px; border-radius: 5px;">
                                        <p id="previewText"></p>
                                    </div>
                                </div>

                                <!-- Mobile Image Upload -->
                                <div class="form-group">
                                    <label for="sliderMobileImage">Mobile Image (Optional)</label>
                                    <div class="file-upload-area" onclick="document.getElementById('sliderMobileImage').click()">
                                        <input type="file" id="sliderMobileImage" name="mobileImage" accept="image/*" style="display: none;">
                                        <div class="file-upload-content">
                                            <i class="fas fa-mobile-alt fa-2x"></i>
                                            <p>Click to select mobile image</p>
                                            <small>Recommended: 800x600px for mobile devices</small>
                                        </div>
                                    </div>
                                    <div id="mobileImagePreview" style="display: none; margin-top: 10px;">
                                        <img id="mobilePreviewImg" src="" alt="Mobile Preview" style="max-width: 200px; border-radius: 5px;">
                                        <p id="mobilePreviewText"></p>
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <!-- Title -->
                                    <div class="form-group">
                                        <label for="sliderTitle">Title *</label>
                                        <input type="text" id="sliderTitle" name="title" class="form-control" required placeholder="Welcome to Qahwat Al Emarat" maxlength="100">
                                    </div>

                                    <!-- Display Order -->
                                    <div class="form-group">
                                        <label for="sliderDisplayOrder">Display Order</label>
                                        <input type="number" id="sliderDisplayOrder" name="displayOrder" class="form-control" value="1" min="0">
                                    </div>
                                </div>

                                <!-- Description -->
                                <div class="form-group">
                                    <label for="sliderDescription">Description</label>
                                    <textarea id="sliderDescription" name="description" class="form-control" rows="3" placeholder="Discover authentic Arabic coffee experience" maxlength="300"></textarea>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <!-- Button Configuration -->
                                    <div class="form-group">
                                        <label for="sliderButtonText">Button Text</label>
                                        <input type="text" id="sliderButtonText" name="buttonText" class="form-control" placeholder="Order Now" maxlength="50">
                                    </div>

                                    <div class="form-group">
                                        <label for="sliderButtonLink">Button Link</label>
                                        <input type="url" id="sliderButtonLink" name="buttonLink" class="form-control" placeholder="https://***REMOVED***.com/menu">
                                    </div>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                    <!-- Colors -->
                                    <div class="form-group">
                                        <label for="sliderBackgroundColor">Background Color</label>
                                        <input type="color" id="sliderBackgroundColor" name="backgroundColor" class="form-control" value="#8B4513">
                                    </div>

                                    <div class="form-group">
                                        <label for="sliderTextColor">Text Color</label>
                                        <input type="color" id="sliderTextColor" name="textColor" class="form-control" value="#FFFFFF">
                                    </div>

                                    <!-- Position -->
                                    <div class="form-group">
                                        <label for="sliderPosition">Text Position</label>
                                        <select id="sliderPosition" name="position" class="form-control">
                                            <option value="left">Left</option>
                                            <option value="center" selected>Center</option>
                                            <option value="right">Right</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Active Status -->
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="sliderIsActive" name="isActive" checked>
                                        Active (visible to users)
                                    </label>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary" onclick="hideAddSliderModal()">Cancel</button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> Create Banner
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3>Hero Banners & Sliders</h3>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <input type="text" class="form-control" placeholder="Search banners..." id="sliderSearch" style="width: 250px;">
                            <select class="form-control" id="sliderStatusFilter" style="width: 150px;">
                                <option value="">All Status</option>
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="section-content">
                        <div id="slidersTable">
                            <!-- Sliders table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? `http://localhost:${window.location.port || '5001'}` 
            : 'https://***REMOVED***.onrender.com';

        // Global variables
        let currentSection = 'dashboard';
        let charts = {};
        let currentUser = null;
        let authToken = null;
        
        // Helper function to validate JWT token format
        function isValidToken(token) {
            if (!token || typeof token !== 'string') return false;
            const parts = token.split('.');
            return parts.length === 3 && parts.every(part => part.length > 0);
        }

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize login form event listeners first
            initializeLoginForm();
            
            // Then check authentication
            checkAuthentication();
        });

        function initializeLoginForm() {
            // Initialize new login form
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            const usernameError = document.getElementById('username-error');
            const passwordError = document.getElementById('password-error');
            const forgotPasswordLink = document.getElementById('forgot-password-link');

            // Focus on username field when page loads (only if visible)
            if (usernameInput && usernameInput.offsetParent !== null) {
                usernameInput.focus();
            }

            // Input validation on blur
            if (usernameInput) {
                usernameInput.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        showError(usernameError, 'Username is required');
                    } else {
                        hideError(usernameError);
                    }
                });
            }

            if (passwordInput) {
                passwordInput.addEventListener('blur', function() {
                    if (!this.value.trim()) {
                        showError(passwordError, 'Password is required');
                    } else {
                        hideError(passwordError);
                    }
                });
            }

            // Forgot password functionality
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    alert('Please contact system administrator to reset your password.');
                });
            }

            // Form submit handler
            const loginForm = document.getElementById('adminLoginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    handleLogin(e);
                });
            }
        }

        // Authentication Functions
        function checkAuthentication() {
            // Check if user is already logged in (stored in localStorage)
            authToken = localStorage.getItem('adminToken');
            currentUser = JSON.parse(localStorage.getItem('adminUser') || 'null');
            
            // Validate token format before using it
            if (authToken && isValidToken(authToken) && currentUser) {
                showAdminPanel();
            } else {
                // Clear invalid token data
                if (authToken && !isValidToken(authToken)) {
                    console.warn('Invalid token format found, clearing localStorage');
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminUser');
                    authToken = null;
                    currentUser = null;
                }
                showLoginPage();
            }
        }

        function showLoginPage() {
            document.body.className = 'login-mode';
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('adminLayout').style.display = 'none';
            
            // Focus on username field after showing login page
            setTimeout(() => {
                const usernameInput = document.getElementById('loginUsername');
                if (usernameInput) {
                    usernameInput.focus();
                }
            }, 100);
        }

        function showAdminPanel() {
            document.body.className = 'admin-mode';
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminLayout').style.display = 'block';
            initializeAdmin();
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            // Reset error states
            resetErrors();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginLoading = document.getElementById('loginLoading');
            const loginError = document.getElementById('loginError');
            const loginSuccess = document.getElementById('loginSuccess');
            const usernameError = document.getElementById('username-error');
            const passwordError = document.getElementById('password-error');
            
            // Validate inputs
            let isValid = true;
            
            if (!username) {
                showError(usernameError, 'Username is required');
                isValid = false;
            }
            
            if (!password) {
                showError(passwordError, 'Password is required');
                isValid = false;
            }
            
            if (!isValid) return;
            
            // Show loading state
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';
            loginBtn.classList.add('loading');
            loginLoading.style.display = 'block';
            
            try {
                // Check hardcoded credentials first (for demo)
                if (username === 'admin' && password === 'almarya2024') {
                    // Successful login with demo token that looks like JWT
                    authToken = 'demo.token.' + Date.now();
                    currentUser = {
                        name: 'Admin User',
                        email: 'admin@qahwat.com',
                        roles: ['admin']
                    };
                    
                    localStorage.setItem('adminToken', authToken);
                    localStorage.setItem('adminUser', JSON.stringify(currentUser));
                    
                    loginSuccess.style.display = 'block';
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        showAdminPanel();
                    }, 1000);
                } else {
                    // Try API login for backward compatibility
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email: username, password })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            // API login successful
                            authToken = data.data.token;
                            currentUser = data.data.user;
                            
                            localStorage.setItem('adminToken', authToken);
                            localStorage.setItem('adminUser', JSON.stringify(currentUser));
                            
                            loginSuccess.style.display = 'block';
                            
                            setTimeout(() => {
                                showAdminPanel();
                            }, 1000);
                        } else {
                            throw new Error('Invalid credentials');
                        }
                    } catch (apiError) {
                        // Failed login
                        loginError.style.display = 'block';
                        
                        // Clear password field for security
                        document.getElementById('loginPassword').value = '';
                        document.getElementById('loginPassword').focus();
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.style.display = 'block';
                
                // Clear password field for security
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            } finally {
                // Hide loading state
                loginBtn.disabled = false;
                loginBtn.textContent = 'Login to Admin Panel';
                loginBtn.classList.remove('loading');
                loginLoading.style.display = 'none';
            }
        }

        function resetErrors() {
            hideError(document.getElementById('username-error'));
            hideError(document.getElementById('password-error'));
            hideError(document.getElementById('loginError'));
            hideError(document.getElementById('loginSuccess'));
        }

        function showError(errorElement, message) {
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }

        function hideError(errorElement) {
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }

        function showLoginError(message) {
            const loginError = document.getElementById('loginError');
            const loginErrorMessage = document.getElementById('loginErrorMessage');
            
            if (loginErrorMessage) {
                loginErrorMessage.textContent = message;
            }
            loginError.style.display = 'block';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                loginError.style.display = 'none';
            }, 5000);
        }

        function logout() {
            // Clear authentication data
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminUser');
            authToken = null;
            currentUser = null;
            
            // Show login page
            showLoginPage();
        }

        // Update API calls to include authentication header
        async function authenticatedFetch(url, options = {}) {
            // Check if we're in demo mode (hardcoded login)
            if (authToken && authToken.startsWith('demo.token.')) {
                console.log('Demo mode: skipping API call to', url);
                // Return mock response for demo mode
                return {
                    ok: true,
                    status: 200,
                    json: async () => ({
                        success: false,
                        message: 'Demo mode - API calls disabled',
                        data: null
                    })
                };
            }
            
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };
            
            // Only add auth header if we have a valid token
            if (authToken && isValidToken(authToken)) {
                defaultHeaders['Authorization'] = `Bearer ${authToken}`;
            }
            
            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };
            
            try {
                const response = await fetch(url, config);
                
                // Check if token is expired or invalid
                if (response.status === 401) {
                    console.warn(`Authentication failed for ${url} - redirecting to login`);
                    logout(); // Always logout on 401 to clear invalid token
                    throw new Error('Authentication expired - please login again');
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response;
            } catch (error) {
                console.error('API Request failed:', error);
                throw error;
            }
        }
        
        // Helper function to handle API responses consistently
        async function handleApiResponse(response) {
            if (!response) {
                throw new Error('No response received');
            }
            
            const data = await response.json();
            return data;
        }

        async function initializeAdmin() {
            showGlobalLoading('Initializing Admin Panel...');
            
            // Initialize production features
            initProductionFeatures();
            
            // Check if in demo mode
            if (authToken && authToken.startsWith('demo.token.')) {
                console.log('Demo mode: Using local demo data');
                renderDemoStats();
                hideGlobalLoading();
                return;
            }
            
            // Check backend connectivity for real API mode
            try {
                const healthCheck = await fetch(`${API_BASE_URL}/health`);
                if (!healthCheck.ok) {
                    console.warn('Backend health check failed');
                }
            } catch (error) {
                console.warn('Backend connectivity check failed:', error.message);
                showErrorById('dashboardStats', 'Backend server unavailable - please start the server');
                hideGlobalLoading();
                return; // Don't try to load data if backend is down
            }
            
            loadDashboardData();
            loadCategories();
            initializeCharts();
            hideGlobalLoading();
        }

        // Section management
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked menu item
            if (event && event.target) {
                event.target.classList.add('active');
            }

            currentSection = sectionName;

            // Use enhanced section loading for demo mode
            if (authToken && authToken.startsWith('demo.token.')) {
                enhanceShowSection(sectionName);
                return;
            }

            // Load section-specific data for real API mode
            switch(sectionName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'categories':
                    loadCategories();
                    break;
                case 'orders':
                    loadOrders();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'sliders':
                    loadSliders();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                showLoading('dashboardStats');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/analytics/admin/dashboard`);
                const data = await handleApiResponse(response);

                if (data.success) {
                    renderDashboardStats(data.data);
                    renderRevenueChart(data.data.revenueData);
                    renderRecentOrders(data.data.recentOrders);
                }
            } catch (error) {
                console.warn('Dashboard data not available:', error.message);
                // Show default dashboard instead of failing
                renderDashboardStats({
                    totalRevenue: 0,
                    totalOrders: 0,
                    totalUsers: 0,
                    revenueData: [],
                    recentOrders: []
                });
                
                if (error.message.includes('Authentication required')) {
                    showErrorById('dashboardStats', 'Please login to view dashboard data');
                } else {
                    showErrorById('dashboardStats', 'Dashboard data unavailable - Backend service starting up');
                }
            }
        }

        function renderDashboardStats(data) {
            const statsHTML = `
                <div class="stat-card">
                    <div class="icon success">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3>AED ${data.totalRevenue?.toLocaleString() || '0'}</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <div class="icon info">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <h3>${data.totalOrders || '0'}</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card">
                    <div class="icon warning">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>${data.totalUsers || '0'}</h3>
                    <p>Total Users</p>
                </div>
                <div class="stat-card">
                    <div class="icon primary">
                        <i class="fas fa-box"></i>
                    </div>
                    <h3>${data.totalProducts || '0'}</h3>
                    <p>Total Products</p>
                </div>
            `;
            document.getElementById('dashboardStats').innerHTML = statsHTML;
        }

        function renderRevenueChart(revenueData) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            if (charts.revenue) {
                charts.revenue.destroy();
            }

            charts.revenue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: revenueData?.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Revenue (AED)',
                        data: revenueData?.values || [1000, 1500, 2000, 1800, 2200, 2500],
                        borderColor: '#8B4513',
                        backgroundColor: 'rgba(139, 69, 19, 0.1)',
                        borderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Revenue Trend'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderRecentOrders(orders) {
            if (!orders || orders.length === 0) {
                document.querySelector('#recentOrdersTable').innerHTML = '<p class="text-center">No recent orders found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => `
                            <tr>
                                <td>#${order._id?.slice(-8) || 'N/A'}</td>
                                <td>${order.user?.name || 'Unknown'}</td>
                                <td>AED ${order.totalAmount?.toFixed(2) || '0.00'}</td>
                                <td><span class="status-badge status-${order.status || 'pending'}">${order.status || 'Pending'}</span></td>
                                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="viewOrder('${order._id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.querySelector('#recentOrdersTable').innerHTML = tableHTML;
        }

        // Analytics functions
        async function loadAnalytics() {
            try {
                const dateRange = document.getElementById('analyticsDateRange')?.value || '30';
                showLoading('popularProductsTable');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/analytics/admin/users?days=${dateRange}`);
                const data = await response.json();

                if (data.success) {
                    renderAnalyticsStats(data.data);
                    renderEngagementChart(data.data.engagementData);
                    renderPopularProducts(data.data.popularProducts);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                showErrorById('popularProductsTable', 'Failed to load analytics data');
            }
        }

        function renderAnalyticsStats(data) {
            document.getElementById('totalViews').textContent = data.totalViews?.toLocaleString() || '0';
            document.getElementById('uniqueVisitors').textContent = data.uniqueVisitors?.toLocaleString() || '0';
            document.getElementById('conversionRate').textContent = `${data.conversionRate?.toFixed(1) || '0.0'}%`;
            document.getElementById('avgSessionTime').textContent = `${data.avgSessionTime || '0'}m`;
        }

        function renderEngagementChart(engagementData) {
            const ctx = document.getElementById('engagementChart').getContext('2d');
            
            if (charts.engagement) {
                charts.engagement.destroy();
            }

            charts.engagement = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: engagementData?.labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'User Sessions',
                        data: engagementData?.values || [120, 150, 180, 200, 250, 300, 280],
                        backgroundColor: 'rgba(139, 69, 19, 0.8)',
                        borderColor: '#8B4513',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'User Engagement by Day'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderPopularProducts(products) {
            if (!products || products.length === 0) {
                document.getElementById('popularProductsTable').innerHTML = '<p class="text-center">No product data available.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Views</th>
                            <th>Orders</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td>${product.name?.en || product.name || 'Unknown'}</td>
                                <td>${product.category?.name?.en || 'N/A'}</td>
                                <td>${product.views || '0'}</td>
                                <td>${product.orders || '0'}</td>
                                <td>AED ${product.revenue?.toFixed(2) || '0.00'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('popularProductsTable').innerHTML = tableHTML;
        }

        // Products functions
        async function loadProducts() {
            try {
                showLoading('productsTable');
                
                // Use demo data if in demo mode
                if (authToken && authToken.startsWith('demo.token.')) {
                    loadDemoProducts();
                    return;
                }
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/coffees`);
                const data = await response.json();

                if (data.success) {
                    renderProductsTable(data.data);
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showErrorById('productsTable', 'Failed to load products');
            }
        }

        function renderProductsTable(products) {
            if (!products || products.length === 0) {
                document.getElementById('productsTable').innerHTML = '<p class="text-center">No products found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Origin & Roast</th>
                            <th>Size Variants & Prices</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => {
                            // Format size variants display
                            const formatVariants = (variants) => {
                                if (!variants || variants.length === 0) {
                                    return `<span class="price-badge">AED ${(product.price || 0).toFixed(2)}</span>`;
                                }
                                
                                return variants.filter(v => v.isActive).map(variant => `
                                    <div class="variant-display">
                                        <span class="variant-size">${variant.size}</span>
                                        <span class="variant-price">AED ${variant.price.toFixed(2)}</span>
                                        <span class="variant-stock">(${variant.stock || 0} in stock)</span>
                                    </div>
                                `).join('');
                            };

                            return `
                            <tr>
                                <td>
                                    <img src="${product.image || '/assets/images/default-coffee.jpg'}" 
                                         alt="${product.name?.en || 'Product'}" 
                                         style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                </td>
                                <td>
                                    <div class="product-name">
                                        <strong>${product.name?.en || product.localizedName || 'N/A'}</strong>
                                        ${product.name?.ar ? `<br><small style="color: #666; direction: rtl;">${product.name.ar}</small>` : ''}
                                        ${product.isFeatured ? '<br><span class="featured-badge">â­ Featured</span>' : ''}
                                    </div>
                                </td>
                                <td>
                                    <div class="product-details">
                                        <strong>${product.origin || 'N/A'}</strong>
                                        <br><small>${product.roastLevel || 'Medium'} Roast</small>
                                        ${product.categories && product.categories.length > 0 ? 
                                            `<br><span class="category-tag">${product.categories[0]}</span>` : ''}
                                    </div>
                                </td>
                                <td>
                                    <div class="variants-display">
                                        ${formatVariants(product.variants)}
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge ${product.isActive ? 'status-active' : 'status-inactive'}">
                                        ${product.isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="viewProduct('${product._id}')" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="editProduct('${product._id}')" title="Edit Product">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct('${product._id}')" title="Delete Product">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('productsTable').innerHTML = tableHTML;
        }

        // Categories functions
        async function loadCategories() {
            try {
                showLoading('categoriesTable');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/categories`);
                const data = await response.json();

                if (data.success) {
                    renderCategoriesTable(data.data);
                    populateCategoryFilter(data.data);
                }
            } catch (error) {
                console.error('Error loading categories:', error);
                showErrorById('categoriesTable', 'Failed to load categories');
            }
        }

        function renderCategoriesTable(categories) {
            if (!categories || categories.length === 0) {
                document.getElementById('categoriesTable').innerHTML = '<p class="text-center">No categories found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Color</th>
                            <th>Order</th>
                            <th>Products</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${categories.map(category => `
                            <tr>
                                <td>
                                    <strong>${category.name?.en || 'N/A'}</strong><br>
                                    <small>${category.name?.ar || ''}</small>
                                </td>
                                <td>
                                    <small>${category.description?.en || 'N/A'}</small>
                                </td>
                                <td>
                                    <div style="width: 30px; height: 30px; background-color: ${category.color || '#ccc'}; border-radius: 50%;"></div>
                                </td>
                                <td>${category.displayOrder || 0}</td>
                                <td>${category.productCount || 0}</td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="editCategory('${category._id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteCategory('${category._id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('categoriesTable').innerHTML = tableHTML;
        }

        function populateCategoryFilter(categories) {
            const select = document.getElementById('productCategoryFilter');
            if (select) {
                select.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(cat => `<option value="${cat._id}">${cat.name?.en || 'N/A'}</option>`).join('');
            }
        }

        // Orders functions
        async function loadOrders() {
            try {
                showLoading('ordersTable');
                
                const status = document.getElementById('orderStatusFilter')?.value || '';
                const url = status ? `${API_BASE_URL}/api/orders?status=${status}` : `${API_BASE_URL}/api/orders`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    renderOrdersTable(data.data);
                    updateOrderStats(data.stats);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showErrorById('ordersTable', 'Failed to load orders');
            }
        }

        function renderOrdersTable(orders) {
            if (!orders || orders.length === 0) {
                document.getElementById('ordersTable').innerHTML = '<p class="text-center">No orders found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => `
                            <tr>
                                <td>#${order._id?.slice(-8) || 'N/A'}</td>
                                <td>
                                    <strong>${order.user?.name || 'Unknown'}</strong><br>
                                    <small>${order.user?.email || ''}</small>
                                </td>
                                <td>${order.items?.length || 0} items</td>
                                <td>AED ${order.totalAmount?.toFixed(2) || '0.00'}</td>
                                <td>
                                    <select class="form-control" onchange="updateOrderStatus('${order._id}', this.value)" style="width: auto; font-size: 0.8rem;">
                                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                                        <option value="confirmed" ${order.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                        <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
                                        <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
                                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </td>
                                <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="viewOrderDetails('${order._id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('ordersTable').innerHTML = tableHTML;
        }

        function updateOrderStats(stats) {
            document.getElementById('pendingOrders').textContent = stats?.pending || '0';
            document.getElementById('preparingOrders').textContent = stats?.preparing || '0';
            document.getElementById('completedOrders').textContent = stats?.completed || '0';
            document.getElementById('todayRevenue').textContent = `AED ${stats?.todayRevenue?.toFixed(2) || '0.00'}`;
        }

        // Users functions
        async function loadUsers() {
            try {
                showLoading('usersTable');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/admin/users`);
                const data = await response.json();

                if (data.success) {
                    renderUsersTable(data.data);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                showErrorById('usersTable', 'Failed to load users');
            }
        }

        function renderUsersTable(users) {
            if (!users || users.length === 0) {
                document.getElementById('usersTable').innerHTML = '<p class="text-center">No users found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Firebase</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const firebaseStatus = user.firebaseUid 
                                ? (user.firebaseSyncStatus === 'synced' ? 'synced' : user.firebaseSyncStatus || 'unknown')
                                : 'not-linked';
                            
                            const firebaseStatusColor = {
                                'synced': 'status-completed',
                                'pending': 'status-warning', 
                                'error': 'status-error',
                                'manual': 'status-inactive',
                                'not-linked': 'status-inactive'
                            };

                            return `
                            <tr>
                                <td>
                                    <strong>${user.name || 'N/A'}</strong>
                                    ${user.firebaseUid ? '<i class="fas fa-link" style="color: #28a745; margin-left: 5px;" title="Linked to Firebase"></i>' : ''}
                                </td>
                                <td>
                                    ${user.email || 'N/A'}
                                    ${user.isEmailVerified ? '<i class="fas fa-check-circle" style="color: #28a745; margin-left: 5px;" title="Email Verified"></i>' : ''}
                                </td>
                                <td>${user.phone || 'N/A'}</td>
                                <td>
                                    <span class="status-badge ${user.roles?.includes('admin') ? 'status-completed' : 'status-active'}">
                                        ${user.roles?.join(', ') || 'Customer'}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${user.isActive ? 'status-active' : 'status-inactive'}">
                                        ${user.isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <span class="status-badge ${firebaseStatusColor[firebaseStatus] || 'status-inactive'}" 
                                          title="${user.firebaseSyncError || 'Firebase sync status'}">
                                        ${firebaseStatus === 'not-linked' ? 'Not Linked' : 
                                          firebaseStatus === 'synced' ? 'âœ“ Synced' :
                                          firebaseStatus === 'pending' ? 'â³ Pending' :
                                          firebaseStatus === 'error' ? 'âŒ Error' :
                                          firebaseStatus === 'manual' ? 'ðŸ‘¤ Manual' : firebaseStatus}
                                    </span>
                                </td>
                                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                                <td style="white-space: nowrap;">
                                    <button class="btn btn-info btn-sm" onclick="editUser('${user._id}')" title="Edit User">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="toggleUserStatus('${user._id}')" title="Toggle Status">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    ${user.firebaseUid 
                                        ? `<button class="btn btn-secondary btn-sm" onclick="syncUserToFirebase('${user._id}')" title="Resync to Firebase">
                                            <i class="fas fa-sync"></i>
                                          </button>`
                                        : `<button class="btn btn-success btn-sm" onclick="syncUserToFirebase('${user._id}')" title="Sync to Firebase">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                          </button>`
                                    }
                                    <button class="btn btn-danger btn-sm" onclick="deleteUser('${user._id}')" title="Delete User">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('usersTable').innerHTML = tableHTML;
        }

        // Settings functions
        function loadSettings() {
            // Load current settings from API or local storage
            // Loading settings...
        }

        function saveSettings() {
            const settings = {
                appName: document.getElementById('appName').value,
                contactEmail: document.getElementById('contactEmail').value,
                contactPhone: document.getElementById('contactPhone').value,
                currency: document.getElementById('currency').value,
                defaultLanguage: document.getElementById('defaultLanguage').value,
                timezone: document.getElementById('timezone').value
            };

            // Saving settings
            alert('Settings saved successfully!');
        }

        // Reports functions
        function loadReports() {
            // Loading reports...
        }

        function generateReport() {
            // Generating new report...
        }

        function downloadReport() {
            const reportType = document.getElementById('reportType').value;
            const dateRange = document.getElementById('reportDateRange').value;
            const format = document.getElementById('reportFormat').value;

            // Downloading report
            alert(`Downloading ${reportType} report in ${format} format for ${dateRange}`);
        }

        // Utility functions
        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading...</p>
                </div>
            `;
        }

        function showErrorById(elementId, message) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const isBackendDown = message.includes('server') || message.includes('Backend');
            const helpText = isBackendDown ? 
                '<small style="display: block; margin-top: 1rem; opacity: 0.8;">ðŸ’¡ Make sure the backend server is running on port 5001</small>' : 
                '';
                
            element.innerHTML = `
                <div class="text-center" style="padding: 2rem; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>${message}</p>
                    ${helpText}
                </div>
            `;
        }

        function refreshDashboard() {
            loadDashboardData();
        }

        function initializeCharts() {
            // Charts will be initialized when data is loaded
        }

        // Action functions (placeholders)
        function viewOrder(orderId) {
            // Viewing order
        }

        function viewOrderDetails(orderId) {
            // Viewing order details
        }

        async function editProduct(productId) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/coffees/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    showEditProductModal(data.data);
                } else {
                    alert('Failed to load product details');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Failed to load product details');
            }
        }

        async function viewProduct(productId) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/coffees/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    const product = data.data;
                    let variantsHtml = '';
                    
                    if (product.variants && product.variants.length > 0) {
                        variantsHtml = product.variants.map(variant => `
                            <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>${variant.displayName?.en || variant.size}</strong>
                                <span style="float: right; color: #28a745; font-weight: bold;">AED ${variant.price.toFixed(2)}</span>
                                <br><small>${variant.description?.en || 'No description'}</small>
                                <br><small>Stock: ${variant.stock || 0} units</small>
                            </div>
                        `).join('');
                    }

                    const productInfo = `
                        Product: ${product.name?.en || 'N/A'}
                        Arabic: ${product.name?.ar || 'N/A'}
                        Origin: ${product.origin || 'N/A'}
                        Roast: ${product.roastLevel || 'N/A'}
                        
                        Size Variants:
                        ${product.variants ? product.variants.map(v => `${v.size}: AED ${v.price}`).join(', ') : 'No variants'}
                    `;
                    
                    alert(productInfo);
                } else {
                    alert('Failed to load product details');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Failed to load product details');
            }
        }

        async function deleteProduct(productId) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/coffees/${productId}`, {
                    method: 'DELETE'
                });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Product deleted successfully');
                        loadProducts(); // Reload products list
                    } else {
                        alert('Failed to delete product: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    alert('Failed to delete product');
                }
        }

        async function editCategory(categoryId) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/categories/${categoryId}`);
                const data = await response.json();
                
                if (data.success) {
                    showEditCategoryModal(data.data);
                } else {
                    alert('Failed to load category details');
                }
            } catch (error) {
                console.error('Error loading category:', error);
                alert('Failed to load category details');
            }
        }

        async function deleteCategory(categoryId) {
            if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
                try {
                    const response = await authenticatedFetch(`${API_BASE_URL}/api/categories/${categoryId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Category deleted successfully');
                        loadCategories(); // Reload categories list
                    } else {
                        alert('Failed to delete category: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error deleting category:', error);
                    alert('Failed to delete category');
                }
            }
        }

        function editUser(userId) {
            // Editing user
        }

        function toggleUserStatus(userId) {
            // Toggling user status
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                const data = await response.json();
                if (data.success) {
                    // Order status updated
                    loadOrders(); // Refresh orders list
                } else {
                    alert('Failed to update order status');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status');
            }
        }

        function showAddProductModal() {
            document.getElementById('productModal').style.display = 'flex';
            document.getElementById('productCreationForm').reset();
            document.getElementById('productImagePreview').style.display = 'none';
            document.getElementById('modalTitle').textContent = 'â˜• Create New Product';
            document.getElementById('createProductBtn').innerHTML = '<i class="fas fa-plus"></i> Create Product';
            
            // Reset variants to default
            resetProductVariants();
        }

        function showEditProductModal(product) {
            const newName = prompt('Product Name (English):', product.name?.en || product.name);
            const newPrice = prompt('Product Price (AED):', product.price);
            
            if (newName && newPrice) {
                updateProduct(product._id || product.id, {
                    name: newName,
                    nameEn: newName,
                    price: parseFloat(newPrice)
                });
            }
        }

        async function updateProduct(productId, updates) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/coffees/${productId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Product updated successfully');
                    loadProducts();
                } else {
                    alert('Failed to update product: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Failed to update product');
            }
        }

        function showAddCategoryModal() {
            const nameEn = prompt('Category Name (English):');
            const nameAr = prompt('Category Name (Arabic):');
            const descEn = prompt('Description (English):');
            const descAr = prompt('Description (Arabic):');
            const color = prompt('Color (hex code):', '#8B4513');
            
            if (nameEn && nameAr) {
                createCategory({
                    name: nameEn,
                    nameEn: nameEn,
                    nameAr: nameAr,
                    description: descEn || '',
                    descriptionEn: descEn || '',
                    descriptionAr: descAr || '',
                    color: color
                });
            }
        }

        function showEditCategoryModal(category) {
            const nameEn = prompt('Category Name (English):', category.name?.en || category.name);
            const nameAr = prompt('Category Name (Arabic):', category.name?.ar || '');
            const descEn = prompt('Description (English):', category.description?.en || category.description);
            const descAr = prompt('Description (Arabic):', category.description?.ar || '');
            const color = prompt('Color (hex code):', category.color || '#8B4513');
            
            if (nameEn) {
                updateCategory(category._id || category.id, {
                    name: nameEn,
                    nameEn: nameEn,
                    nameAr: nameAr || nameEn,
                    description: descEn || '',
                    descriptionEn: descEn || '',
                    descriptionAr: descAr || descEn || '',
                    color: color
                });
            }
        }

        async function createCategory(categoryData) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/categories`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(categoryData)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Category created successfully');
                    loadCategories();
                } else {
                    alert('Failed to create category: ' + data.message);
                }
            } catch (error) {
                console.error('Error creating category:', error);
                alert('Failed to create category');
            }
        }

        async function updateCategory(categoryId, updates) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/categories/${categoryId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Category updated successfully');
                    loadCategories();
                } else {
                    alert('Failed to update category: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating category:', error);
                alert('Failed to update category');
            }
        }

        function showAddUserModal() {
            alert('User creation is available through the registration process or API endpoints.');
        }

        // Sliders functions
        async function loadSliders() {
            try {
                showLoading('slidersTable');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/sliders`);
                const data = await response.json();

                if (data.success) {
                    renderSlidersTable(data.data);
                }
            } catch (error) {
                console.error('Error loading sliders:', error);
                showErrorById('slidersTable', 'Failed to load sliders');
            }
        }

        function renderSlidersTable(sliders) {
            if (!sliders || sliders.length === 0) {
                document.getElementById('slidersTable').innerHTML = '<p class="text-center">No hero banners found.</p>';
                return;
            }

            const tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Order</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sliders.map(slider => `
                            <tr>
                                <td>
                                    <img src="${slider.image || '/assets/images/placeholder.jpg'}" 
                                         alt="${slider.title?.en || 'Slider'}" 
                                         style="width: 100px; height: 60px; border-radius: 5px; object-fit: cover;">
                                </td>
                                <td>
                                    <strong>${slider.title?.en || slider.title || 'N/A'}</strong><br>
                                    <small>${slider.title?.ar || ''}</small>
                                </td>
                                <td>
                                    <small>${slider.description?.en || slider.description || 'N/A'}</small>
                                </td>
                                <td>${slider.displayOrder || 0}</td>
                                <td>
                                    <span class="status-badge ${slider.isActive ? 'status-active' : 'status-inactive'}">
                                        ${slider.isActive ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="editSlider('${slider._id || slider.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteSlider('${slider._id || slider.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('slidersTable').innerHTML = tableHTML;
        }

        // Slider Modal Functions
        function showAddSliderModal() {
            document.getElementById('sliderModal').style.display = 'flex';
            document.getElementById('sliderForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('mobileImagePreview').style.display = 'none';
            
            // Set default values
            document.getElementById('sliderBackgroundColor').value = '#8B4513';
            document.getElementById('sliderTextColor').value = '#FFFFFF';
            document.getElementById('sliderDisplayOrder').value = '1';
            document.getElementById('sliderIsActive').checked = true;
        }

        function hideAddSliderModal() {
            document.getElementById('sliderModal').style.display = 'none';
        }

        // Alias for compatibility
        function closeSliderModal() {
            hideAddSliderModal();
        }

        // Handle file previews for slider images
        document.addEventListener('DOMContentLoaded', function() {
            // Main image preview
            document.getElementById('sliderImage').addEventListener('change', function(e) {
                handleSliderImagePreview(e.target, 'imagePreview', 'previewImg', 'previewText');
            });

            // Mobile image preview
            document.getElementById('sliderMobileImage').addEventListener('change', function(e) {
                handleSliderImagePreview(e.target, 'mobileImagePreview', 'mobilePreviewImg', 'mobilePreviewText');
            });

            // Handle slider form submission
            document.getElementById('sliderForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleSliderFormSubmission(e);
            });
        });

        function handleSliderImagePreview(input, previewId, imgId, textId) {
            const preview = document.getElementById(previewId);
            const img = document.getElementById(imgId);
            const text = document.getElementById(textId);
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    text.textContent = `Selected: ${input.files[0].name}`;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }

        async function handleSliderFormSubmission(event) {
            event.preventDefault();
            
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            
            try {
                const formData = new FormData();
                
                // Get form elements
                const imageFile = document.getElementById('sliderImage').files[0];
                const mobileImageFile = document.getElementById('sliderMobileImage').files[0];
                
                if (!imageFile) {
                    throw new Error('Please select a banner image');
                }
                
                // Add files
                formData.append('image', imageFile);
                if (mobileImageFile) {
                    formData.append('mobileImage', mobileImageFile);
                }
                
                // Add form data
                formData.append('title', document.getElementById('sliderTitle').value);
                formData.append('description', document.getElementById('sliderDescription').value);
                formData.append('buttonText', document.getElementById('sliderButtonText').value);
                formData.append('buttonLink', document.getElementById('sliderButtonLink').value);
                formData.append('backgroundColor', document.getElementById('sliderBackgroundColor').value);
                formData.append('textColor', document.getElementById('sliderTextColor').value);
                formData.append('position', document.getElementById('sliderPosition').value);
                formData.append('displayOrder', document.getElementById('sliderDisplayOrder').value);
                formData.append('isActive', document.getElementById('sliderIsActive').checked);
                
                // Make API request - use custom fetch for FormData
                const response = await fetch(`${API_BASE_URL}/api/sliders`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                        // Don't set Content-Type, let browser set it for FormData
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Success - show notification and close modal
                    showNotification('Hero banner created successfully!', 'success');
                    hideAddSliderModal();
                    loadSliders(); // Refresh the table
                } else {
                    throw new Error(data.message || 'Failed to create slider');
                }
                
            } catch (error) {
                console.error('Slider creation error:', error);
                showNotification(`Error: ${error.message}`, 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Helper function to show notifications
        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification alert alert-${type === 'error' ? 'danger' : type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 3000;
                min-width: 300px;
                max-width: 500px;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-left: 10px;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }



        // Product Modal Functions
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function resetProductVariants() {
            // Set default values for variants
            document.querySelector('input[name="variant_250gm_price"]').value = '45.00';
            document.querySelector('input[name="variant_500gm_price"]').value = '80.00';
            document.querySelector('input[name="variant_1kg_price"]').value = '150.00';
            
            document.querySelector('input[name="variant_250gm_stock"]').value = '100';
            document.querySelector('input[name="variant_500gm_stock"]').value = '100';
            document.querySelector('input[name="variant_1kg_stock"]').value = '50';
            
            // Set default descriptions
            document.querySelector('input[name="variant_250gm_desc_en"]').value = 'Perfect for trying new flavors';
            document.querySelector('input[name="variant_250gm_desc_ar"]').value = 'Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù†ÙƒÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
            
            document.querySelector('input[name="variant_500gm_desc_en"]').value = 'Perfect for regular consumption';
            document.querySelector('input[name="variant_500gm_desc_ar"]').value = 'Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ù†ØªØ¸Ù…';
            
            document.querySelector('input[name="variant_1kg_desc_en"]').value = 'Perfect for bulk purchase and sharing';
            document.querySelector('input[name="variant_1kg_desc_ar"]').value = 'Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©';
        }

        // Handle product image preview and form submission
        document.addEventListener('DOMContentLoaded', function() {
            const productImageInput = document.getElementById('productImage');
            const productImagePreview = document.getElementById('productImagePreview');
            const productPreviewImg = document.getElementById('productPreviewImg');

            if (productImageInput) {
                productImageInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            productPreviewImg.src = event.target.result;
                            productImagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
            }

            // Handle product form submission
            const productForm = document.getElementById('productCreationForm');
            if (productForm) {
                productForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await createProductWithUpload();
                });
            }

            // Close modal when clicking outside
            const productModal = document.getElementById('productModal');
            if (productModal) {
                productModal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeProductModal();
                    }
                });
            }
        });

        async function createProductWithUpload() {
            const form = document.getElementById('productCreationForm');
            const createBtn = document.getElementById('createProductBtn');
            const imageFile = document.getElementById('productImage').files[0];
            
            if (!imageFile) {
                alert('Please select a product image');
                return;
            }

            // Validate required fields
            const nameEn = document.getElementById('productNameEn').value.trim();
            const nameAr = document.getElementById('productNameAr').value.trim();
            const descEn = document.getElementById('productDescEn').value.trim();
            const descAr = document.getElementById('productDescAr').value.trim();
            const origin = document.getElementById('productOrigin').value.trim();

            if (!nameEn || !nameAr || !descEn || !descAr || !origin) {
                alert('Please fill in all required fields');
                return;
            }

            // Validate variant prices
            const price250 = parseFloat(document.querySelector('input[name="variant_250gm_price"]').value);
            const price500 = parseFloat(document.querySelector('input[name="variant_500gm_price"]').value);
            const price1kg = parseFloat(document.querySelector('input[name="variant_1kg_price"]').value);

            if (!price250 || !price500 || !price1kg || price250 <= 0 || price500 <= 0 || price1kg <= 0) {
                alert('Please enter valid prices for all size variants');
                return;
            }

            try {
                // Show loading state
                createBtn.disabled = true;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Product...';

                const formData = new FormData();
                
                // Add image
                formData.append('image', imageFile);

                // Add basic product data
                formData.append('nameEn', nameEn);
                formData.append('nameAr', nameAr);
                formData.append('descriptionEn', descEn);
                formData.append('descriptionAr', descAr);
                formData.append('origin', origin);
                formData.append('roastLevel', document.getElementById('productRoastLevel').value);
                formData.append('price', price500); // Use 500gm price as base price
                formData.append('isActive', document.getElementById('productIsActive').checked);
                formData.append('isFeatured', document.getElementById('productIsFeatured').checked);

                // Prepare categories and tags
                const categories = document.getElementById('productCategories').value.split(',').map(c => c.trim()).filter(c => c);
                const tags = document.getElementById('productTags').value.split(',').map(t => t.trim()).filter(t => t);
                
                formData.append('categories', JSON.stringify(categories));
                formData.append('tags', JSON.stringify(tags));

                // Prepare variants
                const variants = [
                    {
                        size: '250gm',
                        weight: 250,
                        price: price250,
                        stock: parseInt(document.querySelector('input[name="variant_250gm_stock"]').value) || 0,
                        description: {
                            en: document.querySelector('input[name="variant_250gm_desc_en"]').value || 'Perfect for trying new flavors',
                            ar: document.querySelector('input[name="variant_250gm_desc_ar"]').value || 'Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù†ÙƒÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'
                        },
                        displayName: {
                            en: '250gm Pack',
                            ar: 'Ø¹Ø¨ÙˆØ© Ù¢Ù¥Ù  Ø¬Ø±Ø§Ù…'
                        },
                        isActive: document.querySelector('input[name="variant_250gm_active"]').checked
                    },
                    {
                        size: '500gm',
                        weight: 500,
                        price: price500,
                        stock: parseInt(document.querySelector('input[name="variant_500gm_stock"]').value) || 0,
                        description: {
                            en: document.querySelector('input[name="variant_500gm_desc_en"]').value || 'Perfect for regular consumption',
                            ar: document.querySelector('input[name="variant_500gm_desc_ar"]').value || 'Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ù†ØªØ¸Ù…'
                        },
                        displayName: {
                            en: '500gm Pack',
                            ar: 'Ø¹Ø¨ÙˆØ© Ù¥Ù Ù  Ø¬Ø±Ø§Ù…'
                        },
                        isActive: document.querySelector('input[name="variant_500gm_active"]').checked
                    },
                    {
                        size: '1kg',
                        weight: 1000,
                        price: price1kg,
                        stock: parseInt(document.querySelector('input[name="variant_1kg_stock"]').value) || 0,
                        description: {
                            en: document.querySelector('input[name="variant_1kg_desc_en"]').value || 'Perfect for bulk purchase and sharing',
                            ar: document.querySelector('input[name="variant_1kg_desc_ar"]').value || 'Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©'
                        },
                        displayName: {
                            en: '1kg Pack',
                            ar: 'Ø¹Ø¨ÙˆØ© ÙƒÙŠÙ„Ùˆ Ø¬Ø±Ø§Ù…'
                        },
                        isActive: document.querySelector('input[name="variant_1kg_active"]').checked
                    }
                ];

                formData.append('variants', JSON.stringify(variants));

                const response = await authenticatedFetch(`${API_BASE_URL}/api/coffees`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('ðŸŽ‰ Product created successfully with size variants!');
                    closeProductModal();
                    loadProducts(); // Refresh the products list
                } else {
                    throw new Error(data.message || 'Failed to create product');
                }

            } catch (error) {
                console.error('Error creating product:', error);
                alert('Failed to create product: ' + error.message);
            } finally {
                // Reset button state
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Product';
            }
        }

        // Handle image preview
        document.addEventListener('DOMContentLoaded', function() {
            const imageInput = document.getElementById('sliderImage');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            previewImg.src = event.target.result;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
            }

            // Handle form submission
            const sliderForm = document.getElementById('sliderForm');
            if (sliderForm) {
                sliderForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await createSliderWithUpload();
                });
            }

            // Close modal when clicking outside
            document.getElementById('sliderModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeSliderModal();
                }
            });
        });

        async function createSliderWithUpload() {
            const form = document.getElementById('sliderForm');
            const createBtn = document.getElementById('createSliderBtn');
            const imageFile = document.getElementById('sliderImage').files[0];
            
            if (!imageFile) {
                alert('Please select a banner image');
                return;
            }

            // Validate image file
            if (!imageFile.type.startsWith('image/')) {
                alert('Please select a valid image file (JPG, PNG, etc.)');
                return;
            }

            if (imageFile.size > 10 * 1024 * 1024) { // 10MB limit
                alert('Image file is too large. Please select an image smaller than 10MB.');
                return;
            }

            try {
                // Show loading state
                createBtn.disabled = true;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                const formData = new FormData();
                
                // Add image files
                formData.append('image', imageFile);
                const mobileImageFile = document.getElementById('sliderMobileImage').files[0];
                if (mobileImageFile) {
                    if (mobileImageFile.type.startsWith('image/')) {
                        formData.append('mobileImage', mobileImageFile);
                    }
                }

                // Add form data
                const title = document.getElementById('sliderTitle').value.trim();
                if (!title) {
                    alert('Please enter a title for the banner');
                    return;
                }

                formData.append('title', title);
                formData.append('description', document.getElementById('sliderDescription').value.trim());
                formData.append('buttonText', document.getElementById('sliderButtonText').value.trim());
                formData.append('buttonLink', document.getElementById('sliderButtonLink').value.trim());
                formData.append('backgroundColor', document.getElementById('sliderBackgroundColor').value);
                formData.append('textColor', document.getElementById('sliderTextColor').value);
                formData.append('position', document.getElementById('sliderPosition').value);
                formData.append('displayOrder', parseInt(document.getElementById('sliderDisplayOrder').value) || 1);
                formData.append('isActive', document.getElementById('sliderIsActive').checked.toString());

                // Make the API request with better error handling
                // Use the same authentication method as other admin functions
                const response = await authenticatedFetch(`${API_BASE_URL}/api/sliders`, {
                    method: 'POST',
                    body: formData
                });

                // Check if response is OK
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = 'Unknown error occurred';
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // If not JSON, use status text
                        errorMessage = `Server error (${response.status}): ${response.statusText}`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (data.success) {
                    alert('ðŸŽ‰ Hero banner created successfully!');
                    closeSliderModal();
                    loadSliders(); // Refresh the sliders list
                } else {
                    throw new Error(data.message || 'Failed to create banner');
                }

            } catch (error) {
                console.error('Error creating slider:', error);
                
                let userMessage = 'Failed to create banner: ' + error.message;
                
                // Provide specific guidance based on error type
                if (error.message.includes('Image is required')) {
                    userMessage = 'âŒ The backend requires image upload functionality that is currently being deployed. Please try again in a few minutes, or contact the administrator.';
                } else if (error.message.includes('500')) {
                    userMessage = 'âŒ Server error occurred. The backend might be updating. Please try again in a few minutes.';
                } else if (error.message.includes('Network')) {
                    userMessage = 'âŒ Network error. Please check your internet connection and try again.';
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    userMessage = 'âŒ Authentication failed. Please refresh the page and login again.';
                }
                
                alert(userMessage);
                
            } finally {
                // Reset button state
                createBtn.disabled = false;
                createBtn.innerHTML = '<i class="fas fa-plus"></i> Create Banner';
            }
        }

        async function editSlider(sliderId) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/sliders/${sliderId}`);
                const data = await response.json();
                
                if (data.success) {
                    showEditSliderModal(data.data);
                } else {
                    alert('Failed to load slider details');
                }
            } catch (error) {
                console.error('Error loading slider:', error);
                alert('Failed to load slider details');
            }
        }

        function showEditSliderModal(slider) {
            const titleEn = prompt('Slider Title (English):', slider.title?.en || slider.title);
            const titleAr = prompt('Slider Title (Arabic):', slider.title?.ar || '');
            const descEn = prompt('Description (English):', slider.description?.en || slider.description);
            const descAr = prompt('Description (Arabic):', slider.description?.ar || '');
            const displayOrder = prompt('Display Order:', slider.displayOrder || 0);
            
            if (titleEn) {
                updateSlider(slider._id || slider.id, {
                    title: titleEn,
                    titleEn: titleEn,
                    titleAr: titleAr || titleEn,
                    description: descEn || '',
                    descriptionEn: descEn || '',
                    descriptionAr: descAr || descEn || '',
                    displayOrder: parseInt(displayOrder) || 0
                });
            }
        }

        async function updateSlider(sliderId, updates) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/sliders/${sliderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('Slider updated successfully');
                    loadSliders();
                } else {
                    alert('Failed to update slider: ' + data.message);
                }
            } catch (error) {
                console.error('Error updating slider:', error);
                alert('Failed to update slider');
            }
        }

        async function deleteSlider(sliderId) {
            if (confirm('Are you sure you want to delete this hero banner? This action cannot be undone.')) {
                try {
                    const response = await authenticatedFetch(`${API_BASE_URL}/api/sliders/${sliderId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Hero banner deleted successfully');
                        loadSliders();
                    } else {
                        alert('Failed to delete hero banner: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error deleting slider:', error);
                    alert('Failed to delete hero banner');
                }
            }
        }

        // Firebase Sync Functions
        async function showFirebaseSyncDashboard() {
            const dashboard = document.getElementById('firebaseSyncDashboard');
            if (dashboard.style.display === 'none') {
                dashboard.style.display = 'block';
                await loadFirebaseSyncStatus();
            } else {
                dashboard.style.display = 'none';
            }
        }

        async function loadFirebaseSyncStatus() {
            try {
                showLoading('syncResults');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/status`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data;
                    
                    document.getElementById('syncTotalUsers').textContent = status.totalUsers || 0;
                    document.getElementById('syncSyncedUsers').textContent = status.syncedUsers || 0;
                    document.getElementById('syncPendingUsers').textContent = status.pendingUsers || 0;
                    document.getElementById('syncErrorUsers').textContent = status.errorUsers || 0;
                    
                    // Update dashboard with enhanced status info
                    const syncPercentage = parseFloat(status.syncPercentage || 0);
                    const statusText = status.firebaseEnabled 
                        ? `Firebase Integration: âœ… Active (${syncPercentage}% synced)`
                        : `Firebase Integration: âŒ Not Configured`;
                    
                    // Determine alert type based on sync status
                    let alertType = 'success';
                    if (!status.firebaseEnabled) {
                        alertType = 'warning';
                    } else if (status.errorUsers > 0) {
                        alertType = 'warning';
                    } else if (syncPercentage < 100) {
                        alertType = 'info';
                    }
                    
                    // Show enhanced status in results area
                    document.getElementById('syncResults').style.display = 'block';
                    document.getElementById('syncResultsContent').innerHTML = `
                        <div class="alert alert-${alertType}">
                            <h4><i class="fas fa-sync"></i> Firebase Sync Status</h4>
                            <strong>${statusText}</strong><br><br>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>User Statistics:</strong><br>
                                    ðŸ“Š Total Users: <strong>${status.totalUsers}</strong><br>
                                    âœ… Synced Users: <strong>${status.syncedUsers}</strong><br>
                                    ðŸ”„ Pending Users: <strong>${status.pendingUsers}</strong><br>
                                    âŒ Error Users: <strong>${status.errorUsers}</strong>
                                </div>
                                <div class="col-md-6">
                                    <strong>Firebase Integration:</strong><br>
                                    ðŸ”‘ Users with Firebase UID: <strong>${status.withFirebaseUid}</strong><br>
                                    ðŸ“ˆ Sync Progress: <strong>${syncPercentage}%</strong><br>
                                    ðŸ”§ Firebase Enabled: <strong>${status.firebaseEnabled ? 'Yes' : 'No'}</strong>
                                </div>
                            </div>
                            ${status.errorUsers > 0 ? '<br><div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Some users have sync errors. Use bulk sync to retry failed operations.</div>' : ''}
                            ${syncPercentage === 100 ? '<br><div class="alert alert-success"><i class="fas fa-check-circle"></i> All users are successfully synced with Firebase!</div>' : ''}
                        </div>
                    `;
                } else {
                    showErrorById('syncResultsContent', 'Failed to load sync status: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading sync status:', error);
                showErrorById('syncResultsContent', 'Network error - make sure the backend server is running and accessible.');
            }
        }

        async function syncUserToFirebase(userId) {
            try {
                // Ensure Firebase sync dashboard is visible
                await showFirebaseSyncDashboard();
                
                showLoading('syncResults');
                const syncResults = document.getElementById('syncResults');
                const syncResultsContent = document.getElementById('syncResultsContent');
                
                if (syncResults) syncResults.style.display = 'block';
                if (syncResultsContent) {
                    syncResultsContent.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Syncing user to Firebase...</p>';
                }
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/sync-to-firebase/${userId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (syncResultsContent) {
                        syncResultsContent.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> ${data.message}
                            </div>
                        `;
                    }
                    showToast('User synced to Firebase successfully!', 'success');
                    
                    // Refresh users table
                    await loadUsers();
                    await loadFirebaseSyncStatus();
                } else {
                    if (syncResultsContent) {
                        syncResultsContent.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> ${data.message}
                            </div>
                        `;
                    }
                    showToast(`Failed to sync user: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error syncing user:', error);
                const syncResultsContent = document.getElementById('syncResultsContent');
                if (syncResultsContent) {
                    syncResultsContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> Failed to sync user to Firebase
                        </div>
                    `;
                } else {
                    showToast('Failed to sync user to Firebase', 'error');
                }
            }
        }

        // Email validation function
        function isValidEmail(email) {
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
            return emailRegex.test(email);
        }

        async function validateUsersForFirebase() {
            try {
                showLoading('syncResults');
                document.getElementById('syncResults').style.display = 'block';
                
                // Get all users to check their emails
                const response = await authenticatedFetch(`${API_BASE_URL}/api/users`);
                const data = await response.json();
                
                if (data.success) {
                    const users = data.data;
                    const invalidUsers = users.filter(user => !isValidEmail(user.email));
                    
                    if (invalidUsers.length > 0) {
                        document.getElementById('syncResultsContent').innerHTML = `
                            <div class="alert alert-warning">
                                <h4><i class="fas fa-exclamation-triangle"></i> Email Validation Issues Found</h4>
                                <p>The following users have invalid email addresses that won't work with Firebase:</p>
                                <ul>
                                    ${invalidUsers.map(user => `<li><strong>${user.name}</strong>: "${user.email}" - Invalid email format</li>`).join('')}
                                </ul>
                                <p><strong>Recommendation:</strong> Update these email addresses to valid formats (e.g., user@domain.com) before syncing to Firebase.</p>
                            </div>
                        `;
                        return false;
                    } else {
                        document.getElementById('syncResultsContent').innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> All user email addresses are valid for Firebase sync!
                            </div>
                        `;
                        return true;
                    }
                } else {
                    showErrorById('syncResultsContent', 'Failed to validate users: ' + data.message);
                    return false;
                }
            } catch (error) {
                console.error('Error validating users:', error);
                showErrorById('syncResultsContent', 'Failed to validate users for Firebase');
                return false;
            }
        }

        async function bulkSyncToFirebase() {
            try {
                // First validate all user emails
                const validationPassed = await validateUsersForFirebase();
                if (!validationPassed) {
                    const proceedAnyway = confirm('Some users have invalid email addresses. Do you want to proceed anyway? (Only valid emails will be synced)');
                    if (!proceedAnyway) return;
                }
                
                const batchSize = prompt('Enter batch size (users to process in parallel):', '10');
                if (!batchSize || isNaN(batchSize)) return;
                
                const confirmSync = confirm(`Sync ALL users to Firebase in batches of ${batchSize}? This will create/update Firebase Auth accounts for all users.`);
                if (!confirmSync) return;
                
                // Ensure Firebase sync dashboard is visible
                await showFirebaseSyncDashboard();
                
                showLoading('syncResults');
                const syncResults = document.getElementById('syncResults');
                const syncResultsContent = document.getElementById('syncResultsContent');
                
                if (syncResults) syncResults.style.display = 'block';
                if (syncResultsContent) {
                    syncResultsContent.innerHTML = `
                        <div class="alert alert-info">
                            <h4><i class="fas fa-sync fa-spin"></i> Bulk Sync to Firebase in Progress</h4>
                            <p>Processing users... Please wait, this may take a few minutes.</p>
                        </div>
                    `;
                }
                
                // Use simple POST request instead of SSE
                const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/bulk-sync-to-firebase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ batchSize: parseInt(batchSize) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.data;
                    if (syncResultsContent) {
                        syncResultsContent.innerHTML = `
                            <div class="alert alert-success">
                                <h4><i class="fas fa-check-circle"></i> Bulk Sync to Firebase Completed!</h4>
                                <p><strong>Total:</strong> ${results.total} users</p>
                                <p><strong>Synced:</strong> ${results.synced} users</p>
                                <p><strong>Errors:</strong> ${results.errors} users</p>
                                ${results.errors > 0 ? '<p><em>Check individual user sync status for error details</em></p>' : ''}
                            </div>
                        `;
                    }
                    
                    // Refresh users table and status
                    setTimeout(async () => {
                        await loadUsers();
                        await loadFirebaseSyncStatus();
                    }, 1000);
                } else {
                    if (syncResultsContent) {
                        syncResultsContent.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> ${data.message}
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error in bulk sync:', error);
                const syncResultsContent = document.getElementById('syncResultsContent');
                if (syncResultsContent) {
                    syncResultsContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> Failed to sync users to Firebase: ${error.message}
                        </div>
                    `;
                } else {
                    showToast(`Failed to sync users to Firebase: ${error.message}`, 'error');
                }
            }
        }

        async function bulkSyncFromFirebase() {
            try {
                const batchSize = prompt('Enter batch size (Firebase users to process in parallel):', '15');
                if (!batchSize || isNaN(batchSize)) return;
                
                const confirmSync = confirm(`Sync ALL Firebase users to local database in batches of ${batchSize}? This will import all Firebase Auth users.`);
                if (!confirmSync) return;
                
                // Ensure Firebase sync dashboard is visible
                await showFirebaseSyncDashboard();
                
                showLoading('syncResults');
                const syncResults = document.getElementById('syncResults');
                const syncResultsContent = document.getElementById('syncResultsContent');
                
                if (syncResults) syncResults.style.display = 'block';
                if (syncResultsContent) {
                    syncResultsContent.innerHTML = `
                        <div class="alert alert-info">
                            <h4><i class="fas fa-download fa-spin"></i> Bulk Sync from Firebase in Progress</h4>
                            <p>Importing Firebase users to local database... Please wait, this may take a few minutes.</p>
                        </div>
                    `;
                }
                
                // Use simple POST request instead of SSE
                const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/bulk-sync-from-firebase`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ batchSize: parseInt(batchSize) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.data;
                    if (syncResultsContent) {
                        syncResultsContent.innerHTML = `
                            <div class="alert alert-success">
                                <h4><i class="fas fa-check-circle"></i> Bulk Sync from Firebase Completed!</h4>
                                <p><strong>Total Firebase Users:</strong> ${results.total}</p>
                                <p><strong>Synced:</strong> ${results.synced} users</p>
                                <p><strong>Errors:</strong> ${results.errors} users</p>
                                ${results.errors > 0 ? '<p><em>Check individual user records for error details</em></p>' : ''}
                            </div>
                        `;
                    }
                    
                    // Refresh users table and status
                    setTimeout(async () => {
                        await loadUsers();
                        await loadFirebaseSyncStatus();
                    }, 1000);
                } else {
                    if (syncResultsContent) {
                        syncResultsContent.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle"></i> ${data.message}
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error in bulk sync from Firebase:', error);
                const syncResultsContent = document.getElementById('syncResultsContent');
                if (syncResultsContent) {
                    syncResultsContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> Failed to sync users from Firebase: ${error.message}
                        </div>
                    `;
                } else {
                    showToast(`Failed to sync users from Firebase: ${error.message}`, 'error');
                }
            }
        }

        async function quickSyncToFirebase() {
            try {
                showLoading('syncResults');
                document.getElementById('syncResults').style.display = 'block';
                document.getElementById('syncResultsContent').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-bolt fa-spin"></i> Quick syncing pending users to Firebase...
                    </div>
                `;
                
                // Get pending users first
                const pendingResponse = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/pending-sync`);
                const pendingData = await pendingResponse.json();
                
                if (!pendingData.success || pendingData.data.length === 0) {
                    document.getElementById('syncResultsContent').innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No pending users found. All users are already synced!
                        </div>
                    `;
                    return;
                }
                
                const pendingUsers = pendingData.data;
                let processed = 0;
                let synced = 0;
                let errors = 0;
                
                document.getElementById('syncResultsContent').innerHTML = `
                    <div class="alert alert-info">
                        <h4><i class="fas fa-bolt fa-spin"></i> Quick Sync in Progress</h4>
                        <p>Syncing ${pendingUsers.length} pending users to Firebase...</p>
                        <div class="progress mb-2" style="height: 20px;">
                            <div id="quickSyncProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%">0%</div>
                        </div>
                        <small id="quickSyncStatus">Starting sync...</small>
                    </div>
                `;
                
                // Process users in batches of 5 for quick sync
                const batchSize = 5;
                for (let i = 0; i < pendingUsers.length; i += batchSize) {
                    const batch = pendingUsers.slice(i, i + batchSize);
                    
                    // Process batch in parallel
                    const batchPromises = batch.map(async (user) => {
                        try {
                            const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/sync-to-firebase/${user._id}`, {
                                method: 'POST'
                            });
                            const result = await response.json();
                            
                            processed++;
                            if (result.success) {
                                synced++;
                            } else {
                                errors++;
                            }
                            
                            // Update progress
                            const progressPercent = (processed / pendingUsers.length) * 100;
                            document.getElementById('quickSyncProgressBar').style.width = progressPercent + '%';
                            document.getElementById('quickSyncProgressBar').textContent = Math.round(progressPercent) + '%';
                            document.getElementById('quickSyncStatus').textContent = 
                                `${processed}/${pendingUsers.length} users processed (${synced} synced, ${errors} errors)`;
                            
                            return result;
                            
                        } catch (error) {
                            processed++;
                            errors++;
                            return { success: false, error: error.message };
                        }
                    });
                    
                    await Promise.all(batchPromises);
                    
                    // Small delay between batches
                    if (i + batchSize < pendingUsers.length) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }
                
                // Show completion
                document.getElementById('syncResultsContent').innerHTML = `
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle"></i> Quick Sync Completed!</h4>
                        <p><strong>Pending Users:</strong> ${pendingUsers.length}</p>
                        <p><strong>Synced:</strong> ${synced} users</p>
                        <p><strong>Errors:</strong> ${errors} users</p>
                        ${errors > 0 ? '<p><em>Check individual user sync status for error details</em></p>' : ''}
                    </div>
                `;
                
                // Refresh data
                setTimeout(async () => {
                    await loadUsers();
                    await loadFirebaseSyncStatus();
                }, 1000);
                
            } catch (error) {
                console.error('Error in quick sync:', error);
                document.getElementById('syncResultsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> Quick sync failed: ${error.message}
                    </div>
                `;
            }
        }

        async function showPendingSyncUsers() {
            try {
                showLoading('syncResults');
                document.getElementById('syncResults').style.display = 'block';
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/pending-sync`);
                const data = await response.json();
                
                if (data.success) {
                    const users = data.data;
                    
                    if (users.length === 0) {
                        document.getElementById('syncResultsContent').innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No users pending Firebase sync
                            </div>
                        `;
                    } else {
                        const usersHtml = users.map(user => `
                            <tr>
                                <td>${user.name}</td>
                                <td>${user.email}</td>
                                <td><span class="status-badge status-${user.firebaseSyncStatus === 'error' ? 'error' : 'warning'}">${user.firebaseSyncStatus}</span></td>
                                <td>${user.firebaseSyncError || 'N/A'}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" onclick="syncUserToFirebase('${user._id}')">
                                        <i class="fas fa-sync"></i> Sync Now
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                        
                        document.getElementById('syncResultsContent').innerHTML = `
                            <div class="alert alert-warning">
                                <h4><i class="fas fa-exclamation-triangle"></i> Users Pending Firebase Sync (${users.length})</h4>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Error</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${usersHtml}
                                </tbody>
                            </table>
                        `;
                    }
                } else {
                    showErrorById('syncResultsContent', 'Failed to load pending sync users: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading pending sync users:', error);
                showErrorById('syncResultsContent', 'Failed to load pending sync users');
            }
        }

        async function showFirebaseUsers() {
            try {
                showLoading('syncResults');
                document.getElementById('syncResults').style.display = 'block';
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/firebase-users`);
                const data = await response.json();
                
                if (data.success) {
                    const users = data.data.users;
                    
                    if (users.length === 0) {
                        document.getElementById('syncResultsContent').innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No users found in Firebase
                            </div>
                        `;
                    } else {
                        const usersHtml = users.map(user => `
                            <tr>
                                <td>${user.displayName || 'N/A'}</td>
                                <td>${user.email}</td>
                                <td>${user.phoneNumber || 'N/A'}</td>
                                <td><span class="status-badge ${user.emailVerified ? 'status-completed' : 'status-warning'}">${user.emailVerified ? 'Verified' : 'Unverified'}</span></td>
                                <td><span class="status-badge ${user.disabled ? 'status-error' : 'status-active'}">${user.disabled ? 'Disabled' : 'Active'}</span></td>
                                <td>${user.creationTime ? new Date(user.creationTime).toLocaleDateString() : 'N/A'}</td>
                            </tr>
                        `).join('');
                        
                        document.getElementById('syncResultsContent').innerHTML = `
                            <div class="alert alert-info">
                                <h4><i class="fas fa-cloud"></i> Firebase Users (${users.length})</h4>
                            </div>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Email Status</th>
                                        <th>Account Status</th>
                                        <th>Created</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${usersHtml}
                                </tbody>
                            </table>
                        `;
                    }
                } else {
                    showErrorById('syncResultsContent', 'Failed to load Firebase users: ' + data.message);
                }
            } catch (error) {
                console.error('Error loading Firebase users:', error);
                showErrorById('syncResultsContent', 'Failed to load Firebase users');
            }
        }

        // Enhanced delete user function to handle Firebase sync
        async function deleteUser(userId) {
            try {
                const confirmDelete = confirm('Are you sure you want to delete this user? This action cannot be undone and will also remove their Firebase account if linked.');
                if (!confirmDelete) return;

                // Get user details first
                const userResponse = await authenticatedFetch(`${API_BASE_URL}/api/admin/users/${userId}`);
                const userData = await userResponse.json();
                
                if (userData.success && userData.data.firebaseUid) {
                    // Delete from Firebase first
                    const firebaseResponse = await authenticatedFetch(`${API_BASE_URL}/api/firebase-sync/firebase-user/${userData.data.firebaseUid}`, {
                        method: 'DELETE'
                    });
                    
                    if (!firebaseResponse.ok) {
                        const firebaseError = await firebaseResponse.json();
                        console.warn('Failed to delete Firebase user:', firebaseError.message);
                    }
                }
                
                // Delete from local database
                const response = await authenticatedFetch(`${API_BASE_URL}/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('User deleted successfully');
                    await loadUsers();
                    await loadFirebaseSyncStatus();
                } else {
                    alert('Failed to delete user: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        }

        // ===== PRODUCTION-READY FEATURES =====

        // Demo Data Storage System
        const demoData = {
            products: [
                { id: 1, name: 'Arabic Coffee Premium', price: 45, category: 'Coffee Beans', stock: 150, status: 'active' },
                { id: 2, name: 'Turkish Coffee Special', price: 38, category: 'Coffee Beans', stock: 120, status: 'active' },
                { id: 3, name: 'Espresso Blend', price: 52, category: 'Coffee Beans', stock: 80, status: 'active' }
            ],
            categories: [
                { id: 1, name: 'Coffee Beans', description: 'Premium coffee beans from around the world' },
                { id: 2, name: 'Equipment', description: 'Coffee brewing equipment and accessories' },
                { id: 3, name: 'Merchandise', description: 'Branded merchandise and gifts' }
            ],
            orders: [
                { id: 1001, customerName: 'Ahmed Hassan', items: 2, total: 90, status: 'completed', date: '2025-10-15' },
                { id: 1002, customerName: 'Fatima Al-Zahra', items: 1, total: 45, status: 'pending', date: '2025-10-15' },
                { id: 1003, customerName: 'Mohammed Ali', items: 3, total: 135, status: 'processing', date: '2025-10-14' }
            ],
            users: [
                { id: 1, name: 'Admin User', email: 'admin@qahwat.com', role: 'admin', status: 'active', joinDate: '2025-01-01' },
                { id: 2, name: 'Sarah Ahmed', email: 'sarah@example.com', role: 'customer', status: 'active', joinDate: '2025-10-10' },
                { id: 3, name: 'Omar Khalil', email: 'omar@example.com', role: 'customer', status: 'active', joinDate: '2025-10-12' }
            ]
        };

        // Global Loading Functions
        function showGlobalLoading(message = 'Loading...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('globalLoading').style.display = 'flex';
        }

        function hideGlobalLoading() {
            document.getElementById('globalLoading').style.display = 'none';
        }

        // Toast Notification System
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Remove after duration
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, duration);
        }



        // Enhanced Demo Data Functions
        function getDemoData(type) {
            return demoData[type] || [];
        }

        function addDemoData(type, item) {
            if (!demoData[type]) demoData[type] = [];
            item.id = Date.now(); // Simple ID generation
            demoData[type].push(item);
            showToast(`${type.slice(0, -1)} added successfully!`);
            return item;
        }

        function updateDemoData(type, id, updates) {
            const items = demoData[type];
            const index = items.findIndex(item => item.id == id);
            if (index !== -1) {
                demoData[type][index] = { ...items[index], ...updates };
                showToast(`${type.slice(0, -1)} updated successfully!`);
                return demoData[type][index];
            }
            return null;
        }

        function deleteDemoData(type, id) {
            const items = demoData[type];
            const index = items.findIndex(item => item.id == id);
            if (index !== -1) {
                demoData[type].splice(index, 1);
                showToast(`${type.slice(0, -1)} deleted successfully!`);
                return true;
            }
            return false;
        }

        // Enhanced Load Functions with Demo Data
        function loadDemoProducts() {
            const products = getDemoData('products');
            let html = products.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>AED ${product.price}</td>
                    <td>${product.category}</td>
                    <td>${product.stock}</td>
                    <td><span class="status-badge ${product.status}">${product.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editDemoProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDemoProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            if (html) {
                document.getElementById('productsTable').innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${html}</tbody>
                    </table>
                `;
            }
        }

        function editDemoProduct(id) {
            const product = getDemoData('products').find(p => p.id == id);
            if (product) {
                showToast(`Editing ${product.name}`, 'info');
                // In a real app, this would open an edit modal
            }
        }

        function deleteDemoProduct(id) {
            const product = getDemoData('products').find(p => p.id == id);
            if (product) {
                deleteDemoData('products', id);
                loadDemoProducts();
                showToast(`Deleted product: ${product.name}`, 'success');
            }
        }

        // Enhanced Dashboard with Demo Data
        function renderDemoStats() {
            const products = getDemoData('products');
            const orders = getDemoData('orders');
            const users = getDemoData('users');
            
            const totalRevenue = orders.reduce((sum, order) => sum + order.total, 0);
            const completedOrders = orders.filter(o => o.status === 'completed').length;
            
            document.getElementById('dashboardStats').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ’°</div>
                        <div class="stat-info">
                            <h3>AED ${totalRevenue}</h3>
                            <p>Total Revenue</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ“¦</div>
                        <div class="stat-info">
                            <h3>${orders.length}</h3>
                            <p>Total Orders</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ðŸ‘¥</div>
                        <div class="stat-info">
                            <h3>${users.length}</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">â˜•</div>
                        <div class="stat-info">
                            <h3>${products.length}</h3>
                            <p>Products</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'd':
                            e.preventDefault();
                            showSection('dashboard');
                            showToast('Switched to Dashboard', 'info', 1500);
                            break;
                        case 'p':
                            e.preventDefault();
                            showSection('products');
                            showToast('Switched to Products', 'info', 1500);
                            break;
                        case 'o':
                            e.preventDefault();
                            showSection('orders');
                            showToast('Switched to Orders', 'info', 1500);
                            break;
                        case 'u':
                            e.preventDefault();
                            showSection('users');
                            showToast('Switched to Users', 'info', 1500);
                            break;
                    }
                }
            });
        }

        // Enhanced Section Loading
        function enhanceShowSection(sectionName) {
            showGlobalLoading(`Loading ${sectionName}...`);
            
            setTimeout(() => {
                switch(sectionName) {
                    case 'products':
                        loadDemoProducts();
                        break;
                    case 'dashboard':
                        renderDemoStats();
                        break;
                    // Add more cases as needed
                }
                hideGlobalLoading();
            }, 500); // Simulate loading time
        }

        // Auto-save functionality
        let autoSaveTimer;
        function setupAutoSave() {
            // Save demo data to localStorage every 30 seconds
            autoSaveTimer = setInterval(() => {
                localStorage.setItem('demoData', JSON.stringify(demoData));
                console.log('Demo data auto-saved');
            }, 30000);
        }

        // Load saved demo data
        function loadSavedDemoData() {
            const saved = localStorage.getItem('demoData');
            if (saved) {
                Object.assign(demoData, JSON.parse(saved));
                console.log('Demo data loaded from localStorage');
            }
        }

        // Initialize Production Features
        function initProductionFeatures() {
            loadSavedDemoData();
            setupKeyboardShortcuts();
            setupAutoSave();
            
            // Show welcome toast for demo mode
            if (authToken && authToken.startsWith('demo.token.')) {
                setTimeout(() => {
                    showToast('Welcome to Al Marya Rostery Admin Panel! ðŸŽ‰', 'success', 4000);
                }, 1000);
            }
        }

        // Performance Monitoring
        function trackPerformance() {
            if ('performance' in window) {
                window.addEventListener('load', () => {
                    setTimeout(() => {
                        const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                        if (loadTime > 0) {
                            console.log(`Page loaded in ${loadTime}ms`);
                        }
                        
                        
                        // Track to localStorage for analytics only if loadTime is valid
                        if (loadTime > 0) {
                            const perfData = JSON.parse(localStorage.getItem('perfData') || '[]');
                            perfData.push({ 
                                timestamp: Date.now(), 
                                loadTime,
                                userAgent: navigator.userAgent.substring(0, 100)
                            });
                            
                            // Keep only last 10 entries
                            if (perfData.length > 10) perfData.shift();
                            localStorage.setItem('perfData', JSON.stringify(perfData));
                        }
                    }, 100);
                });
            }
        }

        // Input Sanitization
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#x27;')
                .replace(/\//g, '&#x2F;');
        }

        // Error Boundary
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showToast('An unexpected error occurred. Please refresh the page.', 'error', 5000);
        });

        // ===== AUTO FIREBASE SYNC FUNCTIONS =====
        
        // Load auto sync status
        async function loadAutoSyncStatus() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/auto-sync/status`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data;
                    
                    // Update status display
                    document.getElementById('autoSyncStatus').textContent = status.isRunning ? 'ðŸŸ¢ Running' : 'ðŸ”´ Stopped';
                    
                    // Update last sync time
                    if (status.lastSyncTime) {
                        const lastSync = new Date(status.lastSyncTime);
                        document.getElementById('autoSyncLastRun').textContent = lastSync.toLocaleTimeString();
                    } else {
                        document.getElementById('autoSyncLastRun').textContent = 'Never';
                    }
                    
                    // Update success rate
                    const successRate = status.stats.totalSyncs > 0 
                        ? ((status.stats.successfulSyncs / status.stats.totalSyncs) * 100).toFixed(1)
                        : '0';
                    document.getElementById('autoSyncSuccessRate').textContent = `${successRate}%`;
                    
                    // Update next sync countdown
                    if (status.nextSyncIn !== null && status.isRunning) {
                        const nextSyncSeconds = Math.ceil(status.nextSyncIn / 1000);
                        document.getElementById('autoSyncNextRun').textContent = `${nextSyncSeconds}s`;
                    } else {
                        document.getElementById('autoSyncNextRun').textContent = status.isRunning ? 'Soon' : '--';
                    }
                    
                    // Update buttons
                    const startBtn = document.getElementById('startAutoSyncBtn');
                    const stopBtn = document.getElementById('stopAutoSyncBtn');
                    
                    if (status.isRunning) {
                        startBtn.style.display = 'none';
                        stopBtn.style.display = 'inline-flex';
                    } else {
                        startBtn.style.display = 'inline-flex';
                        stopBtn.style.display = 'none';
                    }
                    
                } else {
                    console.error('âŒ Failed to load auto sync status:', data.message);
                }
            } catch (error) {
                console.error('âŒ Error loading auto sync status:', error.message);
                document.getElementById('autoSyncStatus').textContent = 'âŒ Error';
            }
        }
        
        // Start automatic sync
        async function startAutoSync() {
            try {
                showToast('Starting automatic Firebase sync...', 'info');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/auto-sync/start`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('ðŸ¤– Automatic Firebase sync started! New users will auto-sync every minute.', 'success', 5000);
                    await loadAutoSyncStatus();
                } else {
                    showToast(`Failed to start auto sync: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('âŒ Error starting auto sync:', error.message);
                showToast('Failed to start automatic sync', 'error');
            }
        }
        
        // Stop automatic sync
        async function stopAutoSync() {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/auto-sync/stop`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Automatic Firebase sync stopped', 'success');
                    await loadAutoSyncStatus();
                } else {
                    showToast(`Failed to stop auto sync: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('âŒ Error stopping auto sync:', error.message);
                showToast('Failed to stop automatic sync', 'error');
            }
        }
        
        // Force immediate sync
        async function forceAutoSync() {
            try {
                showToast('Forcing immediate Firebase sync...', 'info');
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/auto-sync/force-sync`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('âš¡ Immediate sync completed! Check for new users.', 'success');
                    await loadAutoSyncStatus();
                    // Refresh users table
                    setTimeout(async () => {
                        await loadUsers();
                        await loadFirebaseSyncStatus();
                    }, 1000);
                } else {
                    showToast(`Failed to force sync: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('âŒ Error forcing sync:', error.message);
                showToast('Failed to force immediate sync', 'error');
            }
        }
        
        // Update sync interval
        async function updateSyncInterval() {
            try {
                const intervalMs = parseInt(document.getElementById('syncIntervalSelect').value);
                
                const response = await authenticatedFetch(`${API_BASE_URL}/api/auto-sync/interval`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ intervalMs })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const intervalText = intervalMs >= 60000 
                        ? `${intervalMs / 60000} minute${intervalMs === 60000 ? '' : 's'}`
                        : `${intervalMs / 1000} seconds`;
                    showToast(`â±ï¸ Sync interval updated to ${intervalText}`, 'success');
                    await loadAutoSyncStatus();
                } else {
                    showToast(`Failed to update interval: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('âŒ Error updating sync interval:', error.message);
                showToast('Failed to update sync interval', 'error');
            }
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            trackPerformance();
            console.log('ðŸš€ Al Marya Rostery Admin Panel v2.1 - AUTO SYNC EDITION');
            console.log('ðŸ¤– NEW: Automatic Firebase User Sync - Real-time user registration sync');
            console.log('âš¡ Features: Demo Mode, Auto-save, Keyboard Shortcuts, Toast Notifications');
            console.log('ðŸ” Security: CSP Headers, Input Sanitization, CSRF Protection');
        });
    </script>

    <!-- Product Creation/Edit Modal -->
    <div id="productModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="modalTitle">â˜• Create New Product</h2>
                <button class="modal-close" onclick="closeProductModal()">&times;</button>
            </div>
            <div class="modal-content">
                <form id="productCreationForm" enctype="multipart/form-data">
                    <!-- Basic Product Information -->
                    <div class="form-section">
                        <h3>Basic Information</h3>
                        
                        <!-- Product Image -->
                        <div class="form-group">
                            <label for="productImage">Product Image *</label>
                            <div class="file-upload-area" onclick="document.getElementById('productImage').click()">
                                <input type="file" id="productImage" name="image" accept="image/*" required style="display: none;">
                                <div class="file-upload-content">
                                    <i class="fas fa-camera" style="font-size: 2rem; color: #8B4513;"></i>
                                    <p>Click to select product image</p>
                                    <small>Recommended: 800x800px, JPG/PNG, max 10MB</small>
                                </div>
                            </div>
                            <div id="productImagePreview" style="display: none; margin-top: 10px;">
                                <img id="productPreviewImg" style="max-width: 150px; max-height: 150px; border-radius: 5px; object-fit: cover;">
                            </div>
                        </div>

                        <!-- Product Names -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productNameEn">Product Name (English) *</label>
                                <input type="text" id="productNameEn" name="nameEn" required placeholder="Premium Arabic Coffee" maxlength="100">
                            </div>
                            <div class="form-group">
                                <label for="productNameAr">Product Name (Arabic) *</label>
                                <input type="text" id="productNameAr" name="nameAr" required placeholder="Ù‚Ù‡ÙˆØ© Ø¹Ø±Ø¨ÙŠØ© ÙØ§Ø®Ø±Ø©" maxlength="100" dir="rtl">
                            </div>
                        </div>

                        <!-- Product Descriptions -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productDescEn">Description (English) *</label>
                                <textarea id="productDescEn" name="descriptionEn" rows="3" required placeholder="Rich and aromatic coffee with deep flavor..." maxlength="1000"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="productDescAr">Description (Arabic) *</label>
                                <textarea id="productDescAr" name="descriptionAr" rows="3" required placeholder="Ù‚Ù‡ÙˆØ© ØºÙ†ÙŠØ© ÙˆØ¹Ø·Ø±Ø© Ø¨Ù†ÙƒÙ‡Ø© Ø¹Ù…ÙŠÙ‚Ø©..." maxlength="1000" dir="rtl"></textarea>
                            </div>
                        </div>

                        <!-- Origin and Roast Level -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productOrigin">Origin *</label>
                                <input type="text" id="productOrigin" name="origin" required placeholder="Yemen, Colombia, Ethiopia..." maxlength="100">
                            </div>
                            <div class="form-group">
                                <label for="productRoastLevel">Roast Level *</label>
                                <select id="productRoastLevel" name="roastLevel" required>
                                    <option value="Light">Light Roast</option>
                                    <option value="Medium-Light">Medium-Light Roast</option>
                                    <option value="Medium" selected>Medium Roast</option>
                                    <option value="Medium-Dark">Medium-Dark Roast</option>
                                    <option value="Dark">Dark Roast</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Size Variants Section -->
                    <div class="form-section">
                        <h3>Size Variants & Pricing</h3>
                        <div id="variantsContainer">
                            <!-- 250gm Variant -->
                            <div class="variant-item" data-size="250gm">
                                <h4>250gm Pack</h4>
                                <div class="form-row variant-row">
                                    <div class="form-group">
                                        <label>Price (AED) *</label>
                                        <input type="number" name="variant_250gm_price" step="0.01" min="0" required placeholder="45.00">
                                    </div>
                                    <div class="form-group">
                                        <label>Stock Quantity</label>
                                        <input type="number" name="variant_250gm_stock" min="0" value="100" placeholder="100">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; gap: 10px;">
                                            <input type="checkbox" name="variant_250gm_active" checked>
                                            Available
                                        </label>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Description (English)</label>
                                        <input type="text" name="variant_250gm_desc_en" placeholder="Perfect for trying new flavors" maxlength="200">
                                    </div>
                                    <div class="form-group">
                                        <label>Description (Arabic)</label>
                                        <input type="text" name="variant_250gm_desc_ar" placeholder="Ù…Ø«Ø§Ù„ÙŠØ© Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù†ÙƒÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©" maxlength="200" dir="rtl">
                                    </div>
                                </div>
                            </div>

                            <!-- 500gm Variant -->
                            <div class="variant-item" data-size="500gm">
                                <h4>500gm Pack</h4>
                                <div class="form-row variant-row">
                                    <div class="form-group">
                                        <label>Price (AED) *</label>
                                        <input type="number" name="variant_500gm_price" step="0.01" min="0" required placeholder="80.00">
                                    </div>
                                    <div class="form-group">
                                        <label>Stock Quantity</label>
                                        <input type="number" name="variant_500gm_stock" min="0" value="100" placeholder="100">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; gap: 10px;">
                                            <input type="checkbox" name="variant_500gm_active" checked>
                                            Available
                                        </label>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Description (English)</label>
                                        <input type="text" name="variant_500gm_desc_en" placeholder="Perfect for regular consumption" maxlength="200">
                                    </div>
                                    <div class="form-group">
                                        <label>Description (Arabic)</label>
                                        <input type="text" name="variant_500gm_desc_ar" placeholder="Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ù†ØªØ¸Ù…" maxlength="200" dir="rtl">
                                    </div>
                                </div>
                            </div>

                            <!-- 1kg Variant -->
                            <div class="variant-item" data-size="1kg">
                                <h4>1kg Pack</h4>
                                <div class="form-row variant-row">
                                    <div class="form-group">
                                        <label>Price (AED) *</label>
                                        <input type="number" name="variant_1kg_price" step="0.01" min="0" required placeholder="150.00">
                                    </div>
                                    <div class="form-group">
                                        <label>Stock Quantity</label>
                                        <input type="number" name="variant_1kg_stock" min="0" value="50" placeholder="50">
                                    </div>
                                    <div class="form-group">
                                        <label style="display: flex; align-items: center; gap: 10px;">
                                            <input type="checkbox" name="variant_1kg_active" checked>
                                            Available
                                        </label>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Description (English)</label>
                                        <input type="text" name="variant_1kg_desc_en" placeholder="Perfect for bulk purchase and sharing" maxlength="200">
                                    </div>
                                    <div class="form-group">
                                        <label>Description (Arabic)</label>
                                        <input type="text" name="variant_1kg_desc_ar" placeholder="Ù…Ø«Ø§Ù„ÙŠØ© Ù„Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø¬Ù…Ù„Ø© ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©" maxlength="200" dir="rtl">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Settings -->
                    <div class="form-section">
                        <h3>Additional Settings</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productCategories">Categories (comma-separated)</label>
                                <input type="text" id="productCategories" name="categories" placeholder="Arabic Coffee, Premium, Traditional">
                            </div>
                            <div class="form-group">
                                <label for="productTags">Tags (comma-separated)</label>
                                <input type="text" id="productTags" name="tags" placeholder="premium, arabic, traditional">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="productIsActive" name="isActive" checked>
                                    Product Active (visible to customers)
                                </label>
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="productIsFeatured" name="isFeatured">
                                    Featured Product
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="createProductBtn">
                            <i class="fas fa-plus"></i> Create Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-container {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: #8B4513;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-content {
            padding: 30px;
        }

        .file-upload-area {
            border: 2px dashed #8B4513;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            background: #f0f0f0;
            border-color: #6B3410;
        }

        .file-upload-content p {
            margin: 10px 0 5px 0;
            font-weight: 500;
            color: #333;
        }

        .file-upload-content small {
            color: #666;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row.three-cols {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-primary {
            background: #8B4513;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #6B3410;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #8B4513;
        }

        .form-section h3 {
            margin: 0 0 20px 0;
            color: #8B4513;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .variant-item {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .variant-item h4 {
            margin: 0 0 15px 0;
            color: #8B4513;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .variant-item h4::before {
            content: "ðŸ“¦";
            font-size: 1.2rem;
        }

        .variant-row {
            margin-bottom: 15px;
        }

        .variant-row .form-group:last-child {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .modal-container {
                width: 95%;
                margin: 10px;
                max-height: 95vh;
            }
            
            .modal-content {
                padding: 20px;
            }

            .form-section {
                padding: 15px;
            }

            .variant-item {
                padding: 15px;
            }
        }

        /* Product Table Styles */
        .product-name strong {
            color: #8B4513;
            font-size: 1rem;
        }

        .featured-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #8B4513;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
        }

        .product-details strong {
            color: #2c3e50;
        }

        .category-tag {
            background: #e9ecef;
            color: #6c757d;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .variants-display {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .variant-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #8B4513;
        }

        .variant-size {
            background: #8B4513;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .variant-price {
            font-weight: 600;
            color: #28a745;
            font-size: 0.9rem;
        }

        .variant-stock {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .price-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .data-table td {
            vertical-align: top;
            padding: 12px 8px;
        }

        .data-table th {
            background: #8B4513;
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 12px 8px;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }
    </style>
</body>
</html>
